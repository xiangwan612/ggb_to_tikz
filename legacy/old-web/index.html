<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-GeoGebra 智能交互绘图平台</title>
    <script src="https://www.geogebra.org/apps/deployggb.js"></script>
    <style>
        /* ========== CSS 变量 - 设计系统 ========== */
        :root {
            /* 主色调 */
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --primary-light: #e0e7ff;
            --primary-dark: #4338ca;
            
            /* 功能色 */
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #3b82f6;
            
            /* 中性色 - 浅色模式 */
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --bg-elevated: #ffffff;
            
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-tertiary: #94a3b8;
            --text-inverse: #ffffff;
            
            --border-color: #e2e8f0;
            --border-light: #f1f5f9;
            
            /* 阴影 */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            
            /* 圆角 */
            --radius-sm: 6px;
            --radius: 10px;
            --radius-md: 14px;
            --radius-lg: 18px;
            --radius-xl: 24px;
            --radius-full: 9999px;
            
            /* 间距 */
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;
            --space-8: 32px;
            
            /* 动画 */
            --transition-fast: 150ms ease;
            --transition: 250ms ease;
            --transition-slow: 350ms ease;
        }

        /* 深色模式 */
        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-elevated: #1e293b;
            
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;
            
            --border-color: #334155;
            --border-light: #1e293b;
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.4), 0 1px 2px -1px rgb(0 0 0 / 0.4);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.4), 0 2px 4px -2px rgb(0 0 0 / 0.4);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.4), 0 4px 6px -4px rgb(0 0 0 / 0.4);
        }

        /* ========== 基础样式 ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.5;
            transition: background-color var(--transition), color var(--transition);
        }

        /* 自定义滚动条 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: var(--radius-full);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-tertiary);
        }

        /* ========== 布局 ========== */
        .container {
            display: flex;
            height: 100vh;
            gap: var(--space-3);
            padding: var(--space-3);
        }

        /* ========== 左侧：AI 交互区 ========== */
        .left-panel {
            width: 380px;
            min-width: 300px;
            max-width: 600px;
            height: 100%;
            max-height: calc(100vh - var(--space-3) * 2);
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            border: 1px solid var(--border-color);
            transition: all var(--transition);
        }

        /* 面板头部 */
        .panel-header {
            padding: var(--space-5) var(--space-5) var(--space-3);
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--text-inverse);
            position: relative;
            overflow: hidden;
        }

        .panel-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
            animation: shimmer 8s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(-10%, -10%) rotate(180deg); }
        }

        .panel-title {
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: var(--space-2);
            position: relative;
            z-index: 1;
        }

        .panel-title .icon {
            font-size: 24px;
        }

        .panel-subtitle {
            font-size: 13px;
            opacity: 0.9;
            margin-top: var(--space-1);
            position: relative;
            z-index: 1;
        }

        /* API 设置区域 */
        .api-settings {
            padding: var(--space-4) var(--space-5);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .settings-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: var(--space-2) 0;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            transition: color var(--transition-fast);
        }

        .settings-toggle:hover {
            color: var(--text-primary);
        }

        .settings-toggle .chevron {
            transition: transform var(--transition);
        }

        .settings-toggle.expanded .chevron {
            transform: rotate(180deg);
        }

        .settings-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height var(--transition), padding var(--transition);
        }

        .settings-content.expanded {
            max-height: 700px;
            padding-top: var(--space-3);
            overflow-y: auto;
        }

        .setting-item {
            margin-bottom: var(--space-3);
        }

        .setting-item:last-child {
            margin-bottom: 0;
        }

        .setting-item label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: var(--space-1);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .setting-item input,
        .setting-item select {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 13px;
            outline: none;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all var(--transition-fast);
        }

        .setting-item input:focus,
        .setting-item select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .setting-row {
            display: flex;
            gap: var(--space-3);
        }

        .setting-row .setting-item {
            flex: 1;
        }

        /* 设置分组 */
        .setting-section {
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-4);
            border-bottom: 1px solid var(--border-color);
        }

        .setting-section:last-of-type {
            border-bottom: none;
            margin-bottom: 0;
        }

        .setting-section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: var(--space-3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .setting-actions {
            display: flex;
            justify-content: flex-end;
            gap: var(--space-2);
            margin-top: var(--space-4);
            padding-top: var(--space-3);
            border-top: 1px solid var(--border-color);
        }

        /* 示例区域 */
        .examples {
            padding: var(--space-4) var(--space-5);
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
        }

        .examples-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: var(--space-3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .example-tags {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
        }

        .tag {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 8px 14px;
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            border: 1px solid transparent;
        }

        .tag:hover {
            background: var(--primary-light);
            color: var(--primary);
            border-color: var(--primary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .tag:active {
            transform: translateY(0);
        }

        /* 聊天工具栏 */
        .chat-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3) var(--space-5);
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
        }

        .chat-toolbar-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .chat-toolbar-btn {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 12px;
            color: var(--text-tertiary);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .chat-toolbar-btn:hover {
            background: var(--bg-secondary);
            color: var(--error);
            border-color: var(--error);
        }

        /* 聊天历史区域 */
        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-4) var(--space-5);
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }

        .empty-state {
            text-align: center;
            color: var(--text-tertiary);
            padding: var(--space-8) var(--space-4);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-4);
        }

        .empty-state .icon {
            width: 80px;
            height: 80px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-xl);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            margin-bottom: var(--space-2);
        }

        .empty-state h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .empty-state p {
            font-size: 14px;
            max-width: 240px;
        }

        /* 聊天消息 - 气泡式设计 */
        .chat-message {
            animation: messageIn 0.3s ease;
            max-width: 90%;
        }

        @keyframes messageIn {
            from { 
                opacity: 0; 
                transform: translateY(10px) scale(0.98); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }

        .chat-message.user {
            align-self: flex-end;
        }

        .chat-message.ai {
            align-self: flex-start;
        }

        .message-bubble {
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-md);
            font-size: 14px;
            line-height: 1.6;
            position: relative;
            word-wrap: break-word;
        }

        .chat-message.user .message-bubble {
            background: var(--primary);
            color: var(--text-inverse);
            border-bottom-right-radius: var(--space-1);
        }

        .chat-message.ai .message-bubble {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: var(--space-1);
            box-shadow: var(--shadow-sm);
        }

        .message-meta {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: var(--space-1);
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }

        .chat-message.user .message-meta {
            justify-content: flex-end;
        }

        .message-avatar {
            width: 28px;
            height: 28px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            margin-bottom: var(--space-1);
        }

        .chat-message.user .message-avatar {
            background: var(--primary-light);
            margin-left: auto;
        }

        .chat-message.ai .message-avatar {
            background: var(--bg-tertiary);
        }

        /* 代码块 */
        .code-block {
            background: #1e293b;
            border-radius: var(--radius);
            margin-top: var(--space-3);
            overflow: hidden;
        }

        .code-header {
            background: #0f172a;
            padding: var(--space-2) var(--space-3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: #94a3b8;
        }

        .code-copy {
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            transition: all var(--transition-fast);
        }

        .code-copy:hover {
            background: #334155;
            color: #f8fafc;
        }

        .code-block pre {
            padding: var(--space-3);
            overflow-x: auto;
            font-family: 'JetBrains Mono', 'Fira Code', Consolas, Monaco, monospace;
            font-size: 12px;
            line-height: 1.5;
            color: #e2e8f0;
        }

        .code-block code {
            font-family: inherit;
        }

        /* 加载状态 */
        .loading-bubble {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-3) var(--space-4);
        }

        .loading-dots {
            display: flex;
            gap: 4px;
        }

        .loading-dots span {
            width: 8px;
            height: 8px;
            background: var(--text-tertiary);
            border-radius: var(--radius-full);
            animation: bounce 1.4s ease-in-out infinite both;
        }

        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* 输入区域 */
        .input-area {
            padding: var(--space-4) var(--space-5);
            background: var(--bg-primary);
            border-top: 1px solid var(--border-color);
        }

        /* ========== 命令编辑器 ========== */
        .command-editor {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            max-height: 300px;
            min-height: 150px;
        }

        .command-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-2) var(--space-4);
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
        }

        .command-editor-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .command-editor-actions {
            display: flex;
            gap: var(--space-2);
        }

        .command-editor-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: var(--space-3);
            gap: var(--space-2);
            overflow: hidden;
        }

        .command-editor textarea {
            flex: 1;
            width: 100%;
            min-height: 80px;
            padding: var(--space-3);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 13px;
            font-family: 'JetBrains Mono', 'Consolas', monospace;
            resize: none;
            outline: none;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .command-editor textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px var(--primary-light);
        }

        .command-editor textarea::placeholder {
            color: var(--text-tertiary);
        }

        .command-editor-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 var(--space-1);
        }

        .command-editor-hint {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        .command-editor-btns {
            display: flex;
            gap: var(--space-2);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .input-wrapper {
            position: relative;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            transition: all var(--transition-fast);
        }

        .input-wrapper:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .input-area textarea {
            width: 100%;
            min-height: 80px;
            max-height: 160px;
            padding: var(--space-3) var(--space-4);
            padding-bottom: 40px;
            border: none;
            border-radius: var(--radius-lg);
            font-size: 14px;
            resize: none;
            outline: none;
            font-family: inherit;
            background: transparent;
            color: var(--text-primary);
            line-height: 1.5;
        }

        .input-area textarea::placeholder {
            color: var(--text-tertiary);
        }

        .input-actions {
            position: absolute;
            bottom: var(--space-2);
            right: var(--space-2);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .input-hint {
            font-size: 11px;
            color: var(--text-tertiary);
            padding: 4px 8px;
        }

        .chat-image-preview {
            display: none;
            margin-top: var(--space-2);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: var(--space-2);
            background: var(--bg-tertiary);
        }

        .chat-image-preview.show {
            display: block;
        }

        .chat-image-preview img {
            max-width: 100%;
            max-height: 160px;
            border-radius: var(--radius-sm);
            display: block;
            object-fit: contain;
            background: var(--bg-primary);
        }

        .chat-image-preview-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: var(--space-2);
            font-size: 12px;
            color: var(--text-secondary);
        }

        .chat-image-remove {
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            padding: 2px 8px;
            cursor: pointer;
        }

        .chat-image-remove:hover {
            color: var(--text-primary);
            border-color: var(--text-tertiary);
        }

        /* 按钮样式 */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-1);
            padding: 8px 16px;
            border-radius: var(--radius);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            border: none;
            outline: none;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--text-inverse);
            box-shadow: 0 1px 2px 0 rgb(99 102 241 / 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgb(99 102 241 / 0.4);
        }

        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            border-radius: var(--radius);
        }

        /* 拖拽分隔线 */
        .resizer {
            width: 6px;
            background: transparent;
            cursor: col-resize;
            transition: background var(--transition-fast);
            position: relative;
            margin: 0 -3px;
            z-index: 10;
        }

        .resizer:hover,
        .resizer.resizing {
            background: var(--primary);
        }

        .resizer::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 2px;
            height: 40px;
            background: var(--border-color);
            border-radius: 1px;
            transition: background var(--transition-fast);
        }

        .resizer:hover::before,
        .resizer.resizing::before {
            background: var(--text-inverse);
        }

        /* 拖拽时的遮罩，防止 iframe 拦截鼠标事件 */
        .resize-mask {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999;
            cursor: col-resize;
        }

        /* ========== 中间：命令编辑器 ========== */
        .center-panel {
            width: 450px;
            min-width: 350px;
            max-width: 600px;
            height: 100%;
            max-height: calc(100vh - var(--space-3) * 2);
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            border: 1px solid var(--border-color);
            transition: all var(--transition);
        }

        .center-panel-header {
            padding: var(--space-4) var(--space-4) var(--space-3);
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: var(--text-inverse);
            position: relative;
        }

        .center-panel-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .center-panel-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: var(--space-3);
            min-height: 0;  /* 确保flex子元素能正确计算高度 */
        }

        /* 命令编辑器在中间列的适配 - 完全覆盖默认样式 */
        .center-panel .command-editor {
            flex: 1;
            display: flex;
            flex-direction: column;
            border: none;
            border-radius: var(--radius);
            background: var(--bg-secondary);
            min-height: 0 !important;
            max-height: none !important;
            height: 100% !important;  /* 填充父容器 */
            overflow: hidden;
        }

        .center-panel .command-editor-header {
            background: var(--bg-tertiary);
            border-radius: var(--radius) var(--radius) 0 0;
            flex-shrink: 0;
        }

        .center-panel .command-editor-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            padding: 0;  /* 覆盖默认的padding */
            overflow: hidden;
        }

        .center-panel .command-editor textarea {
            flex: 1;
            width: 100%;
            min-height: 0 !important;
            max-height: none !important;
            height: 100% !important;
            resize: none;
            border: none;
            border-radius: 0;
            margin: 0;
            /* 确保textarea能正确计算高度 */
            box-sizing: border-box;
        }

        .center-panel .command-editor-footer {
            flex-shrink: 0;
            padding: var(--space-2) 0;  /* 调整padding */
        }

        /* 快捷操作区 */
        .quick-actions {
            display: flex;
            gap: var(--space-2);
            padding: var(--space-3);
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
        }

        .quick-actions .btn {
            flex: 1;
            justify-content: center;
        }

        /* ========== 右侧：绘图展示区 ========== */
        .right-panel {
            flex: 1;
            height: 100%;
            max-height: calc(100vh - var(--space-3) * 2);
            display: flex;
            flex-direction: column;
            min-width: 400px;
            overflow: hidden;
        }

        /* 顶部工具栏 */
        .toolbar-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-primary);
            padding: var(--space-3) var(--space-5);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-3);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .toolbar-title {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .toolbar-title h2 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .toolbar-actions {
            display: flex;
            gap: var(--space-2);
        }

        .toolbar-btn {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: 8px 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .toolbar-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--text-tertiary);
            transform: translateY(-1px);
        }

        .toolbar-btn:active {
            transform: translateY(0);
        }

        .toolbar-btn.danger:hover {
            background: #fef2f2;
            color: var(--error);
            border-color: var(--error);
        }

        /* 右侧设置面板 */
        .right-settings-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.45);
            backdrop-filter: blur(2px);
            z-index: 999;
            display: none;
        }

        .right-settings-overlay.show {
            display: block;
        }

        .right-settings {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: min(780px, calc(100vw - 48px));
            max-height: min(88vh, 920px);
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
            z-index: 1000;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .right-settings.show {
            display: flex;
        }

        .right-settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3) var(--space-4);
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--text-inverse);
            font-weight: 600;
        }

        .right-settings-body {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-4);
        }

        .settings-group {
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-3);
            border-bottom: 1px solid var(--border-light);
        }

        .settings-group:last-child {
            margin-bottom: 0;
            border-bottom: none;
        }

        .settings-group-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: var(--space-3);
            padding-bottom: var(--space-1);
            border-bottom: 1px solid var(--border-light);
        }

        /* 工具栏下拉菜单 */
        .toolbar-dropdown {
            position: relative;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: var(--space-2);
            width: 320px;
            max-height: 70vh;
            overflow-y: auto;
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
            z-index: 1000;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-content {
            padding: var(--space-3);
        }

        .dropdown-section {
            margin-bottom: var(--space-4);
        }

        .dropdown-section:last-child {
            margin-bottom: 0;
        }

        .dropdown-section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: var(--space-2);
            padding-bottom: var(--space-1);
            border-bottom: 1px solid var(--border-light);
        }

        .dropdown-item {
            margin-bottom: var(--space-3);
        }

        .dropdown-item:last-child {
            margin-bottom: 0;
        }

        .dropdown-item.row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--space-2);
        }

        .dropdown-item label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: var(--space-1);
            display: block;
        }

        .dropdown-item.row label {
            margin-bottom: 0;
        }

        .dropdown-item select,
        .dropdown-item input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 12px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .dropdown-item.row select {
            width: auto;
            min-width: 100px;
        }

        .dropdown-input-group {
            display: flex;
            gap: var(--space-2);
        }

        .dropdown-input-group input {
            flex: 1;
        }

        .dropdown-input-group button {
            padding: 6px 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 12px;
            cursor: pointer;
        }

        .dropdown-actions {
            padding-top: var(--space-3);
            border-top: 1px solid var(--border-color);
            text-align: center;
        }

        /* GGB 容器 */
        .ggb-wrapper {
            flex: 1;
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            overflow: hidden;
            position: relative;
            min-height: 0;
            display: flex;  /* 确保子元素能填充 */
        }

        #ggb-element {
            width: 100%;
            height: 100%;
            min-height: 0;  /* 移除600px限制，让flex控制 */
            flex: 1;
        }

        /* 底部信息栏 */
        .footer-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-3) var(--space-5);
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            margin-top: var(--space-3);
        }

        .footer-note {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .footer-actions {
            display: flex;
            gap: var(--space-3);
        }

        .theme-toggle {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 6px 12px;
            border-radius: var(--radius);
            transition: all var(--transition-fast);
        }

        .theme-toggle:hover {
            background: var(--bg-secondary);
        }

        /* Toast 提示 */
        .toast-container {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            pointer-events: none;
        }

        .toast {
            background: var(--bg-elevated);
            color: var(--text-primary);
            padding: 12px 20px;
            border-radius: var(--radius);
            font-size: 14px;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: var(--space-2);
            animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s;
            pointer-events: auto;
        }

        @keyframes toastIn {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        @keyframes toastOut {
            from { 
                opacity: 1; 
                transform: translateY(0); 
            }
            to { 
                opacity: 0; 
                transform: translateY(-20px); 
            }
        }

        .toast.success {
            border-left: 3px solid var(--success);
        }

        .toast.error {
            border-left: 3px solid var(--error);
        }

        .toast.info {
            border-left: 3px solid var(--info);
        }

        /* ========== 响应式 ========== */
        @media (max-width: 1024px) {
            .left-panel {
                width: 360px;
            }
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                padding: var(--space-2);
            }

            .left-panel {
                width: 100%;
                height: 50%;
                min-height: 300px;
            }

            .toolbar-wrapper {
                flex-wrap: wrap;
                gap: var(--space-2);
            }

            .toolbar-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }

        /* ========== 动画类 ========== */
        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .scale-in {
            animation: scaleIn 0.2s ease;
        }

        @keyframes scaleIn {
            from { 
                opacity: 0; 
                transform: scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: scale(1); 
            }
        }

        /* ========== 模态框样式 ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition);
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            transform: scale(0.9) translateY(20px);
            transition: transform var(--transition);
            border: 1px solid var(--border-color);
        }

        .modal-overlay.show .modal-content {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            padding: var(--space-4) var(--space-5);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: var(--space-1);
            line-height: 1;
            transition: color var(--transition-fast);
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: var(--space-4) var(--space-5);
            overflow-y: auto;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }

        .modal-footer {
            padding: var(--space-4) var(--space-5);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: var(--space-3);
        }

        /* 提示词编辑器工具栏 */
        .prompt-toolbar {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
            padding: var(--space-3);
            background: var(--bg-secondary);
            border-radius: var(--radius);
        }

        .prompt-presets-inline,
        .prompt-variables {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            flex-wrap: wrap;
        }

        .prompt-presets-inline label,
        .prompt-variables label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .var-tag {
            background: var(--primary-light);
            color: var(--primary);
            border: 1px dashed var(--primary);
            padding: 4px 10px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .var-tag:hover {
            background: var(--primary);
            color: var(--text-inverse);
        }

        /* 提示词编辑区 */
        .prompt-textarea {
            width: 100%;
            min-height: 250px;
            max-height: 400px;
            padding: var(--space-4);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 14px;
            line-height: 1.7;
            font-family: 'JetBrains Mono', 'Fira Code', Consolas, monospace;
            resize: vertical;
            outline: none;
            background: var(--bg-primary);
            color: var(--text-primary);
            tab-size: 2;
        }

        .prompt-textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        /* 提示词预览区 */
        .prompt-preview-section {
            border-top: 1px solid var(--border-color);
            padding-top: var(--space-3);
        }

        .prompt-preview-section label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: var(--space-2);
        }

        .prompt-preview {
            background: #1e293b;
            color: #e2e8f0;
            padding: var(--space-4);
            border-radius: var(--radius);
            font-size: 13px;
            line-height: 1.6;
            font-family: 'JetBrains Mono', monospace;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* 提示词列表 */
        .prompt-list-container {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .prompt-list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-3) var(--space-4);
            background: var(--bg-secondary);
            border: 2px solid transparent;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .prompt-list-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-color);
        }

        .prompt-list-item.active {
            background: var(--primary-light);
            border-color: var(--primary);
        }

        .prompt-list-info {
            flex: 1;
            min-width: 0;
        }

        .prompt-list-name {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .prompt-list-desc {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 2px;
        }

        .prompt-list-actions {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-left: var(--space-3);
        }

        .btn-icon-small {
            width: 28px;
            height: 28px;
            padding: 0;
            background: transparent;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 14px;
            opacity: 0.6;
            transition: all var(--transition-fast);
        }

        .btn-icon-small:hover {
            opacity: 1;
            background: var(--bg-tertiary);
        }

        .prompt-list-item:hover .btn-icon-small {
            opacity: 1;
        }

        .prompt-list-check {
            color: var(--success);
            font-weight: bold;
            margin-left: var(--space-2);
        }

        /* ========== 服务商选择器 ========== */
        .provider-selector {
            display: flex;
            gap: var(--space-3);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            overflow: hidden;
            background: var(--bg-secondary);
        }

        .provider-list {
            width: 140px;
            background: var(--bg-tertiary);
            border-right: 1px solid var(--border-color);
            padding: var(--space-2);
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }

        .provider-item {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-size: 13px;
        }

        .provider-item:hover {
            background: var(--bg-secondary);
        }

        .provider-item.active {
            background: var(--primary);
            color: var(--text-inverse);
        }

        .provider-icon {
            font-size: 16px;
        }

        .provider-name {
            font-weight: 500;
        }

        .provider-config {
            flex: 1;
            padding: var(--space-3);
        }

        .api-key-input-wrapper {
            display: flex;
            gap: var(--space-2);
        }

        .api-key-input-wrapper input {
            flex: 1;
        }

        .api-key-hint {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: var(--space-1);
        }

        .api-key-status {
            margin-left: var(--space-2);
            font-size: 12px;
            font-weight: 500;
        }

        .api-key-status.valid {
            color: var(--success);
        }

        .api-key-status.invalid {
            color: var(--error);
        }

        .api-key-status.checking {
            color: var(--info);
        }

        .btn-check-key {
            background: var(--success) !important;
            color: white !important;
            border-color: var(--success) !important;
        }

        .btn-check-key:hover {
            background: var(--primary-hover) !important;
        }

        .btn-check-key.checking {
            animation: pulse 1.5s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .model-select-wrapper {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .model-select-wrapper select {
            flex: 1;
        }

        .refresh-models-btn {
            width: 32px;
            height: 32px;
            padding: 0;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 14px;
            transition: all var(--transition-fast);
            flex-shrink: 0;
        }

        .refresh-models-btn:hover {
            background: var(--primary-light);
            border-color: var(--primary);
        }

        .refresh-models-btn.spinning {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .provider-delete-btn {
            width: 20px;
            height: 20px;
            padding: 0;
            margin-left: auto;
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            opacity: 0;
            transition: all var(--transition-fast);
        }

        .provider-item:hover .provider-delete-btn {
            opacity: 1;
        }

        .provider-delete-btn:hover {
            color: var(--error);
        }

        .add-provider-btn {
            border: 2px dashed var(--border-color);
            background: transparent;
            color: var(--text-secondary);
        }

        .add-provider-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--primary-light);
        }

        .add-provider-btn .provider-icon {
            font-size: 18px;
            font-weight: bold;
        }

        .model-hint {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: var(--space-1);
        }

        @media (max-width: 600px) {
            .provider-selector {
                flex-direction: column;
            }
            
            .provider-list {
                width: 100%;
                flex-direction: row;
                flex-wrap: wrap;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 左侧：AI 交互区 -->
        <div class="left-panel">
            <!-- 面板头部 -->
            <div class="panel-header">
                <div class="panel-title">
                    <span class="icon">🎨</span>
                    AI-GeoGebra
                </div>
                <div class="panel-subtitle">智能交互绘图平台</div>
            </div>

            <!-- 示例题目 -->
            <div class="examples">
                <div class="examples-title">📚 快速开始</div>
                <div class="example-tags">
                    <button class="tag" onclick="setExample('画一个椭圆，a = 2，b = 1')">椭圆</button>
                    <button class="tag" onclick="setExample('画一个半径为3的圆，圆心在(2,2)')">圆</button>
                    <button class="tag" onclick="setExample('画一个直角三角形，直角边分别为3和4')">直角三角形</button>
                    <button class="tag" onclick="setExample('画函数 y = x^2 的图像，x从-5到5')">抛物线</button>
                    <button class="tag" onclick="setExample('画一个边长为4的正六边形')">正六边形</button>
                </div>
            </div>

            <!-- 聊天历史工具栏 -->
            <div class="chat-toolbar">
                <div class="chat-toolbar-title">💬 对话历史</div>
                <button class="chat-toolbar-btn" onclick="clearConversation()" title="清空对话">
                    🗑️ 清空
                </button>
            </div>

            <!-- 聊天历史 -->
            <div class="chat-history" id="chat-history">
                <div class="empty-state">
                    <div class="icon">✨</div>
                    <h3>开始创作</h3>
                    <p>在下方输入框描述你想要的图形，AI 会帮你生成命令</p>
                </div>
            </div>

            <!-- 输入区域 -->
            <div class="input-area">
                <div class="input-wrapper">
                    <textarea 
                        id="user-input" 
                        placeholder="描述你想要的图形..." 
                        onkeydown="handleKeyDown(event)"
                    ></textarea>
                    <div class="input-actions">
                        <span class="input-hint">Enter 发送 · Ctrl/Cmd+V 粘贴图片</span>
                        <button class="btn btn-primary btn-icon" id="send-btn" onclick="generateGraphic()">
                            <span>➤</span>
                        </button>
                    </div>
                </div>
                <div class="chat-image-preview" id="chat-image-preview">
                    <img id="chat-image-preview-img" alt="粘贴图片预览">
                    <div class="chat-image-preview-meta">
                        <span id="chat-image-preview-text">已粘贴图片</span>
                        <button class="chat-image-remove" type="button" onclick="clearPendingImage()">移除</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 拖拽分隔线 -->
        <div class="resizer" id="resizer"></div>

        <!-- 中间：命令编辑器 -->
        <div class="center-panel" id="center-panel">
            <div class="center-panel-header">
                <div class="center-panel-title">
                    <span>📐</span>
                    <span>GeoGebra 命令编辑器</span>
                </div>
            </div>
            <div class="center-panel-body">
                <!-- GeoGebra 命令编辑器 -->
                <div class="command-editor" id="command-editor">
                    <div class="command-editor-header">
                        <div class="command-editor-title">
                            <span>📝</span>
                            <span>命令列表</span>
                        </div>
                        <div class="command-editor-actions">
                            <button class="btn btn-secondary btn-sm" onclick="readCommandsFromGGB()" title="从画板读取当前命令">
                                📥 读取
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="clearCommandEditor()" title="清空编辑器">
                                🗑️ 清空代码
                            </button>
                        </div>
                    </div>
                    <div class="command-editor-body">
                        <textarea 
                            id="command-input" 
                            placeholder="-- 每行一个 GeoGebra 命令，例如：&#10;A = (1, 2)&#10;B = (3, 4)&#10;Segment(A, B)&#10;Circle(A, B)&#10;Ellipse(F1, F2, P)&#10;&#10;AI 生成的命令会显示在这里，你可以编辑后再执行&#10;快捷键：Ctrl+Enter 执行 | Ctrl+Shift+Enter 逐步执行"
                            spellcheck="false"
                            autocomplete="off"
                            autocorrect="off"
                            autocapitalize="off"
                            onkeydown="handleCommandEditorKeyDown(event)"
                        ></textarea>
                    </div>
                    <div class="command-editor-footer">
                        <span class="command-editor-hint">支持多行命令，按行分割执行</span>
                        <div class="command-editor-btns">
                            <button class="btn btn-primary btn-sm" onclick="executeCommandsStepByStep()" title="逐行执行，便于观察">
                                ▶️ 逐步执行
                            </button>
                            <button class="btn btn-success btn-sm" onclick="executeCommands()" title="立即执行所有命令">
                                ⚡ 执行到画板
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 快捷操作区 -->
                <div class="quick-actions">
                    <button class="btn btn-danger" onclick="clearBoard(false)" title="清空画板但保留命令">
                        🗑️ 清空画布
                    </button>
                    <button class="btn btn-secondary" onclick="clearCommandAndBoard()" title="清空画板和代码">
                        🧹 全部清空
                    </button>
                </div>
            </div>
        </div>

        <!-- 拖拽分隔线2 -->
        <div class="resizer" id="resizer2"></div>

        <!-- 右侧：绘图展示区 -->
        <div class="right-panel">
            <!-- 工具栏 -->
            <div class="toolbar-wrapper">
                <div class="toolbar-title">
                    <span style="font-size: 20px;">📐</span>
                    <h2>绘图板</h2>
                </div>
                <div class="toolbar-actions">
                    <button class="toolbar-btn" onclick="undoCommand()">
                        <span>↩️</span> 撤销
                    </button>
                    <button class="toolbar-btn" onclick="showBoardElements()">
                        <span>📊</span> 画板元素
                    </button>
                    <button class="toolbar-btn" onclick="exportImage()">
                        <span>🖼️</span> <span id="export-btn-text">导出图片</span>
                    </button>
                    <button class="toolbar-btn" onclick="exportTikZToClipboard()">
                        <span>📋</span> 导出 TikZ
                    </button>
                    <button class="toolbar-btn danger" onclick="clearBoard(false)">
                        <span>🗑️</span> 清除画板
                    </button>
                    <button class="toolbar-btn" onclick="toggleRightSettings()">
                        <span>⚙️</span> 设置
                    </button>
                </div>
            </div>

            <!-- 右侧设置面板 -->
            <div class="right-settings" id="right-settings">
                <div class="right-settings-header">
                    <span>⚙️ 设置</span>
                    <button class="btn-icon-small" onclick="toggleRightSettings()">✕</button>
                </div>
                <div class="right-settings-body">
                    <!-- API 配置 -->
                    <div class="settings-group">
                        <div class="settings-group-title">🔌 API 配置</div>
                        <div class="provider-selector" style="margin-bottom: var(--space-3);">
                            <div class="provider-list" id="right-provider-list"></div>
                            <div class="provider-config">
                                <div class="setting-item">
                                    <label>API 密钥 <span id="right-api-key-status" class="api-key-status"></span></label>
                                    <div class="api-key-input-wrapper">
                                        <input type="password" id="right-api-key" placeholder="输入你的 API 密钥">
                                        <button class="btn-icon-small" onclick="toggleRightApiKeyVisibility()">👁️</button>
                                        <button class="btn-icon-small btn-check-key" onclick="checkRightApiKey()">✓</button>
                                    </div>
                                    <div class="api-key-hint" id="right-api-key-hint">选择服务商并输入密钥，点击 ✓ 检测</div>
                                </div>
                                <div class="setting-row">
                                    <div class="setting-item" style="flex: 2;">
                                        <label>模型 <span id="right-model-status" style="font-size: 11px; color: var(--text-tertiary);"></span></label>
                                        <div class="model-select-wrapper">
                                            <select id="right-api-model">
                                                <option value="">请先选择服务商并输入密钥</option>
                                            </select>
                                            <button class="btn-icon-small refresh-models-btn" onclick="refreshRightModelList()">🔄</button>
                                        </div>
                                        <div class="model-hint" id="right-model-hint">输入密钥后自动获取可用模型</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- 提示词设置 -->
                    <div class="settings-group">
                        <div class="settings-group-title">📝 AI 提示词</div>
                        <div class="prompt-list-container" id="right-prompt-list"></div>
                        <button class="btn btn-secondary" onclick="openPromptEditor()" style="width: 100%; margin-top: var(--space-2);">+ 添加自定义提示词</button>
                    </div>
                    <!-- 画布显示 -->
                    <div class="settings-group">
                        <div class="settings-group-title">📐 画布显示</div>
                        <div class="setting-row">
                            <div class="setting-item">
                                <label>坐标轴</label>
                                <select id="right-show-axes">
                                    <option value="true">显示</option>
                                    <option value="false">隐藏</option>
                                </select>
                            </div>
                            <div class="setting-item">
                                <label>网格</label>
                                <select id="right-show-grid">
                                    <option value="true">显示</option>
                                    <option value="false">隐藏</option>
                                </select>
                            </div>
                        </div>
                        <div class="setting-row">
                            <div class="setting-item">
                                <label>字体</label>
                                <select id="right-font-family">
                                    <option value="Arial, sans-serif">Arial</option>
                                    <option value="Times New Roman, serif">Times New Roman</option>
                                    <option value="Georgia, serif">Georgia</option>
                                    <option value="Verdana, sans-serif">Verdana</option>
                                    <option value="Helvetica, sans-serif">Helvetica</option>
                                    <option value="Courier New, monospace">Courier New</option>
                                    <option value="SimSun, serif">宋体</option>
                                    <option value="Microsoft YaHei, sans-serif">微软雅黑</option>
                                </select>
                            </div>
                            <div class="setting-item">
                                <label>字号 (10-20)</label>
                                <input type="number" id="right-font-size" min="10" max="20" value="14">
                            </div>
                        </div>
                    </div>
                    <!-- AI 对话 -->
                    <div class="settings-group">
                        <div class="settings-group-title">🤖 AI 对话</div>
                        <div class="setting-row">
                            <div class="setting-item">
                                <label>上下文记忆</label>
                                <select id="right-context-memory">
                                    <option value="on">开启（推荐）</option>
                                    <option value="off">关闭</option>
                                </select>
                            </div>
                            <div class="setting-item">
                                <label>记忆轮数</label>
                                <input type="number" id="right-max-history" min="5" max="20" value="10">
                            </div>
                        </div>
                    </div>
                    <!-- 导出设置 -->
                    <div class="settings-group">
                        <div class="settings-group-title">🖼️ 导出设置</div>
                        <div class="setting-row">
                            <div class="setting-item">
                                <label>默认格式</label>
                                <select id="right-export-format">
                                    <option value="png">PNG 图片</option>
                                    <option value="ggb">GGB 源文件</option>
                                </select>
                            </div>
                            <div class="setting-item">
                                <label>导出缩放</label>
                                <input type="number" id="right-export-scale" min="1" max="3" step="0.5" value="2">
                            </div>
                        </div>
                    </div>
                    <!-- 应用按钮 -->
                    <div class="settings-actions">
                        <button class="btn btn-secondary" onclick="resetRightSettings()">恢复默认</button>
                        <button class="btn btn-primary" onclick="applyRightSettings()">应用设置</button>
                    </div>
                </div>
            </div>
            <div class="right-settings-overlay" id="right-settings-overlay" onclick="closeRightSettings()"></div>

            <!-- GGB 容器 -->
            <div class="ggb-wrapper">
                <div id="ggb-element"></div>
            </div>

            <!-- 底部信息栏 -->
            <div class="footer-bar">
                <div class="footer-note">
                    <span>🔒</span>
                    <span>您的 API Key 仅保存在浏览器本地，不会上传到任何服务器</span>
                </div>
                <div class="footer-actions">
                    <div class="theme-toggle" onclick="toggleTheme()">
                        <span id="theme-icon">🌙</span>
                        <span id="theme-text">深色模式</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 画板元素查看器模态框 -->
    <div class="modal-overlay" id="elements-viewer-modal" onclick="if(event.target===this)closeElementsViewer()">
        <div class="modal-content" style="max-width: 1000px; max-height: 85vh;">
            <div class="modal-header">
                <h3>📊 画板元素</h3>
                <button class="modal-close" onclick="closeElementsViewer()">&times;</button>
            </div>
            <div class="modal-body" style="display: flex; flex-direction: column; gap: var(--space-3); overflow: hidden;">
                <!-- 统计卡片 -->
                <div class="elements-stats" id="elements-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: var(--space-3);">
                    <!-- 由 JS 生成 -->
                </div>
                
                <!-- 元素列表 -->
                <div class="elements-list" id="elements-list" style="background: var(--bg-secondary); border-radius: var(--radius); overflow: auto; max-height: 400px; border: 1px solid var(--border-color);">
                    <!-- 由 JS 生成 -->
                </div>
                
                <!-- JSON 预览（可折叠） -->
                <details style="font-size: 12px;">
                    <summary style="cursor: pointer; color: var(--text-secondary); padding: var(--space-2);">
                        🔧 查看处理后的 JSON 数据（用于 AI 转换）
                    </summary>
                    <div class="json-preview" id="json-preview" style="background: #1e293b; color: #e2e8f0; padding: var(--space-3); border-radius: var(--radius); font-family: 'JetBrains Mono', monospace; font-size: 11px; line-height: 1.5; overflow: auto; max-height: 200px; white-space: pre; margin-top: var(--space-2);"></div>
                </details>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="showFullRawXML()">📄 查看原始 XML</button>
                <button class="btn btn-secondary" onclick="copyProcessedJSON()">📋 复制 JSON</button>
                <button class="btn btn-secondary" onclick="downloadProcessedJSON()">💾 下载 JSON</button>
                <button class="btn btn-primary" onclick="generateTikZ()">🔄 生成 TikZ</button>
            </div>
        </div>
    </div>

    <!-- 添加自定义服务商模态框 -->
    <div class="modal-overlay" id="add-provider-modal" onclick="if(event.target===this)closeAddProviderModal()">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>➕ 添加自定义服务商</h3>
                <button class="modal-close" onclick="closeAddProviderModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="setting-item" style="margin-bottom: var(--space-3);">
                    <label>服务商名称</label>
                    <input type="text" id="new-provider-name" placeholder="例如：我的 Claude API">
                </div>
                <div class="setting-item">
                    <label>API 地址 (Base URL)</label>
                    <input type="text" id="new-provider-url" placeholder="https://api.example.com/v1">
                    <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 4px;">
                        支持 OpenAI 兼容格式的 API，如 https://api.anthropic.com/v1
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddProviderModal()">取消</button>
                <button class="btn btn-primary" onclick="saveNewProvider()">添加</button>
            </div>
        </div>
    </div>

    <!-- Toast 容器 -->
    <div class="toast-container" id="toast-container"></div>

    <!-- 提示词编辑器模态框（简化版） -->
    <div class="modal-overlay" id="prompt-modal" onclick="closePromptEditorOnOverlay(event)">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 id="prompt-editor-title">📝 添加提示词</h3>
                <button class="modal-close" onclick="closePromptEditor()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="setting-item" style="margin-bottom: var(--space-3);">
                    <label>提示词名称</label>
                    <input type="text" id="prompt-name-input" placeholder="例如：初中几何专用">
                </div>
                
                <div class="prompt-variables" style="margin-bottom: var(--space-3);">
                    <label style="font-size: 12px; color: var(--text-secondary); margin-right: var(--space-2);">插入变量：</label>
                    <button class="var-tag" onclick="insertVariable('{{CURRENT_OBJECTS}}')">{{CURRENT_OBJECTS}}</button>
                    <button class="var-tag" onclick="insertVariable('{{USER_INPUT}}')">{{USER_INPUT}}</button>
                </div>
                
                <textarea id="prompt-editor" class="prompt-textarea" style="min-height: 300px;" placeholder="在此输入提示词...

说明：
- {{CURRENT_OBJECTS}} 会被替换为当前画布的图形
- {{USER_INPUT}} 会被替换为用户的描述

示例：
你是一位几何老师。当前画布已有：{{CURRENT_OBJECTS}}

请根据以下描述生成 GeoGebra 指令：{{USER_INPUT}}

要求：
1. 只输出指令，不要解释
2. 每行一条指令"></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="loadDefaultPromptTemplate()">载入默认模板</button>
                <button class="btn btn-primary" onclick="savePrompt()">保存</button>
            </div>
        </div>
    </div>

    <!-- 加载 GGB 解析器 -->
    <script src="ggb-parser.js"></script>
    <!-- 加载 TikZ 生成器 -->
    <script src="tikz-generator.js"></script>
    
    <script>
        // ========== 全局变量 ==========
        let commandHistory = [];
        let chatHistoryData = [];
        let conversationHistory = []; // AI 对话历史（用于上下文）
        let MAX_HISTORY_LENGTH = 10; // 保留最近10轮对话（可变）
        let currentCustomPrompt = ''; // 用户自定义提示词
        let pendingImageDataUrl = null; // 聊天输入区待发送图片（base64）
        let pendingImageMimeType = '';
        // ggbApp 和 isGGBReady 在下方定义

        // ========== API 服务商配置 ==========
        // models 改为默认列表，实际会从 API 动态获取
        const API_PROVIDERS = {
            openai: {
                name: 'OpenAI',
                icon: '🌐',
                baseUrl: 'https://api.openai.com/v1',
                keyHint: 'sk-...',
                modelsEndpoint: '/models',
                defaultModels: [
                    { value: 'gpt-4o', label: 'GPT-4o' },
                    { value: 'gpt-4o-mini', label: 'GPT-4o Mini' },
                    { value: 'gpt-4-turbo', label: 'GPT-4 Turbo' },
                    { value: 'gpt-3.5-turbo', label: 'GPT-3.5 Turbo' }
                ]
            },
            deepseek: {
                name: 'DeepSeek',
                icon: '',
                baseUrl: 'https://api.deepseek.com/v1',
                keyHint: 'sk-...',
                modelsEndpoint: '/models',
                defaultModels: [
                    { value: 'deepseek-chat', label: 'DeepSeek Chat' },
                    { value: 'deepseek-coder', label: 'DeepSeek Coder' }
                ]
            },
            siliconflow: {
                name: '硅基流动',
                icon: '⚡',
                baseUrl: 'https://api.siliconflow.cn/v1',
                keyHint: 'sk-...',
                modelsEndpoint: '/models',
                defaultModels: [
                    { value: 'deepseek-ai/DeepSeek-V3', label: 'DeepSeek V3' },
                    { value: 'deepseek-ai/DeepSeek-R1', label: 'DeepSeek R1' },
                    { value: 'Qwen/Qwen2.5-72B-Instruct', label: 'Qwen2.5 72B' }
                ]
            },
            doubao: {
                name: '豆包',
                icon: '🟢',
                baseUrl: 'https://ark.cn-beijing.volces.com/api/v3',
                keyHint: '从火山方舟获取 API Key（建议使用推理接入点 ID 作为模型）',
                // 豆包的 /models 端点不稳定，跳过自动获取
                skipModelFetch: true,
                defaultModels: [
                    { id: 'doubao-seed-2-0-pro-260215', name: 'Doubao Seed 2.0 Pro (示例)' },
                    { id: 'doubao-seed-1-6-flash-250715', name: 'Doubao Seed 1.6 Flash (示例)' }
                ]
            },
            qwen: {
                name: '通义千问',
                icon: '🌟',
                baseUrl: 'https://dashscope.aliyuncs.com/compatible-mode/v1',
                keyHint: 'sk-...',
                modelsEndpoint: '/models',
                defaultModels: [
                    { value: 'qwen-turbo', label: 'Qwen Turbo' },
                    { value: 'qwen-plus', label: 'Qwen Plus' },
                    { value: 'qwen-max', label: 'Qwen Max' }
                ]
            },
            kimi: {
                name: 'Kimi',
                icon: '🌙',
                baseUrl: 'https://api.moonshot.cn/v1',
                keyHint: '从 Moonshot 开放平台获取',
                modelsEndpoint: '/models',
                defaultModels: [
                    { value: 'moonshot-v1-8k', label: 'Moonshot V1 8K' },
                    { value: 'moonshot-v1-32k', label: 'Moonshot V1 32K' },
                    { value: 'moonshot-v1-128k', label: 'Moonshot V1 128K' }
                ]
            }
        };

        // 多个自定义服务商存储
        let customProviders = [];

        let currentProvider = 'openai';

        // ========== 安全 DOM 读写 ==========
        function getEl(id) {
            return document.getElementById(id);
        }

        function getInputValue(id, fallback = '') {
            const el = getEl(id);
            return el && typeof el.value !== 'undefined' ? el.value : fallback;
        }

        function setInputValue(id, value) {
            const el = getEl(id);
            if (el && typeof el.value !== 'undefined') {
                el.value = value;
            }
        }

        // ========== 默认提示词 ==========
        const DEFAULT_PROMPT_PATH = 'prompts/default-prompt.txt';
        let DEFAULT_PROMPT = `你是 GeoGebra 指令生成器。只输出每行一条可执行命令，不要解释。
画布对象：
{{CURRENT_OBJECTS}}
用户输入：
{{USER_INPUT}}`;

        async function loadDefaultPromptFromFile() {
            try {
                const resp = await fetch(`${DEFAULT_PROMPT_PATH}?t=${Date.now()}`, { cache: 'no-store' });
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const text = await resp.text();
                const loaded = (text || '').trim();
                if (loaded) {
                    DEFAULT_PROMPT = loaded;
                    console.log('默认提示词已从文件加载:', DEFAULT_PROMPT_PATH);
                }
            } catch (e) {
                console.warn('读取默认提示词文件失败，使用内置兜底模板:', e.message);
            }
        }

        // 自定义提示词列表
        let customPrompts = [];

        // ========== GeoGebra 初始化 ==========
        let ggbApp = null;
        let isGGBReady = false;

        function initGGB() {
            // 读取用户字体设置
            const fontFamily = localStorage.getItem('ggb_font_family') || 'Arial, sans-serif';
            const fontSize = parseInt(localStorage.getItem('ggb_font_size') || '14');
            
            const ggbParams = {
                "appName": "geometry",
                "width": 1200,
                "height": 800,
                "showToolBar": true,
                "showAlgebraInput": true,
                "showMenuBar": true,
                "enableRightClick": true,
                "enableShiftDragZoom": true,
                "showResetIcon": false,
                "enableUndoRedo": true,     // 启用撤销/重做功能
                "language": "zh",
                "appletOnLoad": onGGBLoad,  // 加载完成回调
                "gfgbBase64": null,
                
                // ========== 画布视觉配置 ==========
                "fontFamily": fontFamily,
                "fontSize": fontSize,
                "allowStyleBar": true,
                "preventFocus": false
            };

            const ggbElement = document.getElementById('ggb-element');
            const applet = new GGBApplet(ggbParams, true);
            applet.inject(ggbElement);
        }

        // GeoGebra 加载完成回调
        function onGGBLoad(api) {
            ggbApp = api;
            isGGBReady = true;
            
            // 读取当前设置
            const showAxes = (localStorage.getItem('ggb_show_axes') || 'true') === 'true';
            const showGrid = (localStorage.getItem('ggb_show_grid') || 'true') === 'true';
            
            // 应用显示设置
            ggbApp.setAxesVisible(showAxes, showAxes);  // X轴, Y轴
            ggbApp.setGridVisible(showGrid);
            
            console.log('GeoGebra 加载完成');
            showToast('GeoGebra 加载完成', 'success');
        }

        window.addEventListener('load', initGGB);

        // ========== 主题切换 ==========
        function loadTheme() {
            const savedTheme = localStorage.getItem('ggb_theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeUI(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('ggb_theme', newTheme);
            updateThemeUI(newTheme);
        }

        function updateThemeUI(theme) {
            const icon = document.getElementById('theme-icon');
            const text = document.getElementById('theme-text');
            if (theme === 'dark') {
                icon.textContent = '☀️';
                text.textContent = '浅色模式';
            } else {
                icon.textContent = '🌙';
                text.textContent = '深色模式';
            }
        }

        // ========== 右侧设置面板 ==========
        function toggleRightSettings() {
            const panel = document.getElementById('right-settings');
            const overlay = document.getElementById('right-settings-overlay');
            const willShow = !panel.classList.contains('show');
            panel.classList.toggle('show', willShow);
            overlay?.classList.toggle('show', willShow);
            if (willShow) {
                syncSettingsToRightPanel();
            }
        }

        function closeRightSettings() {
            const panel = document.getElementById('right-settings');
            const overlay = document.getElementById('right-settings-overlay');
            panel?.classList.remove('show');
            overlay?.classList.remove('show');
        }

        function syncSettingsToRightPanel() {
            // 从 localStorage 加载设置到右侧面板
            const settings = {
                apiKey: JSON.parse(localStorage.getItem('ggb_provider_keys') || '{}')[currentProvider] || '',
                apiModel: localStorage.getItem('ggb_api_model') || '',
                showAxes: localStorage.getItem('ggb_show_axes') || 'true',
                showGrid: localStorage.getItem('ggb_show_grid') || 'true',
                fontFamily: localStorage.getItem('ggb_font_family') || 'Arial, sans-serif',
                fontSize: localStorage.getItem('ggb_font_size') || '14',
                contextMemory: localStorage.getItem('ggb_context_memory') || 'on',
                maxHistory: localStorage.getItem('ggb_max_history') || '10',
                exportFormat: localStorage.getItem('ggb_export_format') || 'png',
                exportScale: localStorage.getItem('ggb_export_scale') || '2'
            };
            
            // 同步到右侧面板
            const rightApiKey = document.getElementById('right-api-key');
            const rightApiModel = document.getElementById('right-api-model');
            if (rightApiKey) rightApiKey.value = settings.apiKey;
            if (rightApiModel) rightApiModel.value = settings.apiModel;
            
            const fields = {
                'right-show-axes': settings.showAxes,
                'right-show-grid': settings.showGrid,
                'right-font-family': settings.fontFamily,
                'right-font-size': settings.fontSize,
                'right-context-memory': settings.contextMemory,
                'right-max-history': settings.maxHistory,
                'right-export-format': settings.exportFormat,
                'right-export-scale': settings.exportScale
            };
            
            for (const [id, value] of Object.entries(fields)) {
                const el = document.getElementById(id);
                if (el) el.value = value;
            }
            
            // 渲染服务商列表
            renderProviderList();
            
            // 渲染提示词列表
            const rightPromptList = document.getElementById('right-prompt-list');
            if (rightPromptList) {
                const currentId = localStorage.getItem('ggb_current_prompt_id') || 'default';
                let html = `
                    <div class="prompt-list-item ${currentId === 'default' ? 'active' : ''}" onclick="selectPrompt('default')">
                        <div class="prompt-list-info">
                            <div class="prompt-list-name">🎯 默认提示词</div>
                            <div class="prompt-list-desc">平衡的通用提示词</div>
                        </div>
                        ${currentId === 'default' ? '<span class="prompt-list-check">✓</span>' : ''}
                    </div>
                `;
                customPrompts.forEach((prompt) => {
                    html += `
                        <div class="prompt-list-item ${currentId === prompt.id ? 'active' : ''}" onclick="selectPrompt('${prompt.id}')">
                            <div class="prompt-list-info">
                                <div class="prompt-list-name">${escapeHtml(prompt.name)}</div>
                                <div class="prompt-list-desc">自定义提示词</div>
                            </div>
                            <div class="prompt-list-actions" onclick="event.stopPropagation()">
                                <button class="btn-icon-small" onclick="editPrompt('${prompt.id}')" title="编辑">✏️</button>
                                <button class="btn-icon-small" onclick="deletePrompt('${prompt.id}')" title="删除">🗑️</button>
                                ${currentId === prompt.id ? '<span class="prompt-list-check">✓</span>' : ''}
                            </div>
                        </div>
                    `;
                });
                rightPromptList.innerHTML = html;
            }
        }

        function applyRightSettings() {
            // 从右侧面板读取并保存到 localStorage
            const rightApiKey = document.getElementById('right-api-key');
            const rightApiModel = document.getElementById('right-api-model');
            
            // 保存API密钥
            if (rightApiKey) {
                const savedKeys = JSON.parse(localStorage.getItem('ggb_provider_keys') || '{}');
                savedKeys[currentProvider] = rightApiKey.value.trim();
                localStorage.setItem('ggb_provider_keys', JSON.stringify(savedKeys));
            }
            
            // 保存模型
            if (rightApiModel) {
                localStorage.setItem('ggb_api_model', rightApiModel.value);
            }
            
            // 保存其他设置
            const fields = {
                'right-show-axes': 'ggb_show_axes',
                'right-show-grid': 'ggb_show_grid',
                'right-font-family': 'ggb_font_family',
                'right-font-size': 'ggb_font_size',
                'right-context-memory': 'ggb_context_memory',
                'right-max-history': 'ggb_max_history',
                'right-export-format': 'ggb_export_format',
                'right-export-scale': 'ggb_export_scale'
            };
            
            for (const [elementId, storageKey] of Object.entries(fields)) {
                const el = document.getElementById(elementId);
                if (el) {
                    localStorage.setItem(storageKey, el.value);
                }
            }
            
            // 更新全局变量
            MAX_HISTORY_LENGTH = parseInt(localStorage.getItem('ggb_max_history')) || 10;
            
            // 应用设置到GGB
            if (isGGBReady && ggbApp) {
                const showAxes = localStorage.getItem('ggb_show_axes') === 'true';
                ggbApp.setAxesVisible(showAxes, showAxes);
                ggbApp.setGridVisible(localStorage.getItem('ggb_show_grid') === 'true');
            }
            
            // 更新导出按钮文本
            updateExportButtonText();
            
            // 关闭右侧面板
            closeRightSettings();
            showToast('设置已应用', 'success');
        }

        function resetRightSettings() {
            resetSettings();
            syncSettingsToRightPanel();
        }

        function toggleRightApiKeyVisibility() {
            const input = document.getElementById('right-api-key');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function checkRightApiKey() {
            // 直接检测右侧面板的API Key
            const provider = currentProvider.startsWith('custom_') 
                ? customProviders[parseInt(currentProvider.replace('custom_', ''))]
                : API_PROVIDERS[currentProvider];
            const apiKey = document.getElementById('right-api-key')?.value.trim();
            
            if (!apiKey || !provider) {
                showToast('请先选择服务商并输入 API 密钥', 'warning');
                return;
            }
            
            // 保存密钥
            const savedKeys = JSON.parse(localStorage.getItem('ggb_provider_keys') || '{}');
            savedKeys[currentProvider] = apiKey;
            localStorage.setItem('ggb_provider_keys', JSON.stringify(savedKeys));
            
            // 验证密钥
            verifyApiKey(provider, apiKey);
        }

        async function verifyApiKey(provider, apiKey) {
            const statusSpan = document.getElementById('right-api-key-status');
            if (statusSpan) {
                statusSpan.textContent = '（检测中...）';
                statusSpan.className = 'api-key-status checking';
            }

            if (currentProvider === 'doubao') {
                try {
                    const modelInput = document.getElementById('right-api-model');
                    const probeModel = (modelInput?.value || localStorage.getItem('ggb_api_model') || '').trim();
                    if (!probeModel) {
                        throw new Error('请先选择或手动输入模型 ID（推荐推理接入点 ID）');
                    }

                    const resp = await fetch(`${provider.baseUrl}/responses`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: probeModel,
                            input: [
                                {
                                    role: 'user',
                                    content: [{ type: 'input_text', text: 'ping' }]
                                }
                            ],
                            max_output_tokens: 8
                        })
                    });

                    const raw = await resp.text();
                    const data = (() => { try { return raw ? JSON.parse(raw) : {}; } catch (_) { return {}; } })();

                    if (!resp.ok) {
                        const msg = data?.error?.message || data?.message || raw || `HTTP ${resp.status}`;
                        throw new Error(msg);
                    }

                    if (statusSpan) {
                        statusSpan.textContent = '（有效）';
                        statusSpan.className = 'api-key-status valid';
                    }
                    showToast('豆包 API 密钥与模型检测通过', 'success');
                    loadModelList(currentProvider);
                } catch (e) {
                    if (statusSpan) {
                        statusSpan.textContent = '（无效）';
                        statusSpan.className = 'api-key-status invalid';
                    }
                    showToast(`豆包检测失败：${e.message}`, 'error');
                }
                return;
            }

            // 部分服务商不稳定或不支持 /models，直接使用预设模型
            if (provider.skipModelFetch) {
                if (statusSpan) {
                    statusSpan.textContent = '（已配置）';
                    statusSpan.className = 'api-key-status valid';
                }
                showToast(`${provider.name} 密钥已保存，使用预设模型列表`, 'success');
                loadModelList(currentProvider);
                return;
            }
            
            try {
                const endpoint = provider.modelsEndpoint || '/models';
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 10000);
                let response;
                try {
                    response = await fetch(`${provider.baseUrl}${endpoint}`, {
                        headers: { 'Authorization': `Bearer ${apiKey}` },
                        signal: controller.signal
                    });
                } finally {
                    clearTimeout(timeout);
                }
                
                if (statusSpan) {
                    if (response.ok) {
                        statusSpan.textContent = '（有效）';
                        statusSpan.className = 'api-key-status valid';
                        showToast('API 密钥验证成功', 'success');
                        // 刷新模型列表
                        loadModelList(currentProvider);
                    } else {
                        statusSpan.textContent = '（无效）';
                        statusSpan.className = 'api-key-status invalid';
                        showToast('API 密钥无效', 'error');
                    }
                }
            } catch (e) {
                if (statusSpan) {
                    statusSpan.textContent = '（检测失败）';
                    statusSpan.className = 'api-key-status invalid';
                }
                showToast(`无法验证密钥：${e.message}`, 'warning');
            }
        }

        function refreshRightModelList() {
            // 直接刷新右侧面板的模型列表
            const provider = currentProvider.startsWith('custom_') 
                ? customProviders[parseInt(currentProvider.replace('custom_', ''))]
                : API_PROVIDERS[currentProvider];
            const apiKey = document.getElementById('right-api-key')?.value.trim();
            
            if (!provider) return;
            
            const btn = document.querySelector('.refresh-models-btn');
            if (btn) btn.classList.add('spinning');
            
            // 清除缓存并刷新
            localStorage.removeItem(`ggb_models_${currentProvider}`);
            localStorage.removeItem(`ggb_models_${currentProvider}_time`);
            
            const loadPromise = currentProvider.startsWith('custom_')
                ? loadModelListForCustomProvider(parseInt(currentProvider.replace('custom_', '')), apiKey)
                : loadModelList(currentProvider);

            Promise.resolve(loadPromise).finally(() => {
                if (btn) btn.classList.remove('spinning');
            });
        }

        // ========== 设置管理 ==========
        const defaultSettings = {
            apiBase: '',
            apiKey: '',
            apiModel: 'gpt-4o-mini',
            showAxes: 'true',
            showGrid: 'true',
            fontFamily: 'Arial, sans-serif',
            fontSize: '14',
            contextMemory: 'on',
            maxHistory: '10',
            exportFormat: 'png',
            exportScale: '2',
            exportTransparent: 'false',
            exportTarget: 'download'
        };

        function loadSettings() {
            // 从 localStorage 加载或使用默认值
            const settings = {
                showAxes: localStorage.getItem('ggb_show_axes') || defaultSettings.showAxes,
                showGrid: localStorage.getItem('ggb_show_grid') || defaultSettings.showGrid,
                fontFamily: localStorage.getItem('ggb_font_family') || defaultSettings.fontFamily,
                fontSize: localStorage.getItem('ggb_font_size') || defaultSettings.fontSize,
                contextMemory: localStorage.getItem('ggb_context_memory') || defaultSettings.contextMemory,
                maxHistory: localStorage.getItem('ggb_max_history') || defaultSettings.maxHistory,
                exportFormat: localStorage.getItem('ggb_export_format') || defaultSettings.exportFormat,
                exportScale: localStorage.getItem('ggb_export_scale') || defaultSettings.exportScale,
                exportTransparent: localStorage.getItem('ggb_export_transparent') || defaultSettings.exportTransparent,
                exportTarget: localStorage.getItem('ggb_export_target') || defaultSettings.exportTarget
            };

            // 应用到右侧面板表单
            const rightFields = {
                'right-show-axes': settings.showAxes,
                'right-show-grid': settings.showGrid,
                'right-font-family': settings.fontFamily,
                'right-font-size': settings.fontSize,
                'right-context-memory': settings.contextMemory,
                'right-max-history': settings.maxHistory,
                'right-export-format': settings.exportFormat,
                'right-export-scale': settings.exportScale
            };
            
            for (const [id, value] of Object.entries(rightFields)) {
                const el = document.getElementById(id);
                if (el) el.value = value;
            }

            // 更新全局变量
            MAX_HISTORY_LENGTH = parseInt(settings.maxHistory) || 10;

            return settings;
        }

        function saveSettings() {
            // 从右侧面板读取设置
            const getValue = (id) => {
                const el = document.getElementById(id);
                return el ? el.value : defaultSettings[id.replace('right-', '').replace(/-([a-z])/g, (m, p1) => p1.toUpperCase())];
            };
            
            const settings = {
                showAxes: getValue('right-show-axes'),
                showGrid: getValue('right-show-grid'),
                fontFamily: getValue('right-font-family'),
                fontSize: getValue('right-font-size'),
                contextMemory: getValue('right-context-memory'),
                maxHistory: getValue('right-max-history'),
                exportFormat: getValue('right-export-format'),
                exportScale: getValue('right-export-scale'),
                exportTransparent: 'false',  // 默认值
                exportTarget: 'download'  // 默认值
            };

            // 保存到 localStorage
            Object.entries(settings).forEach(([key, value]) => {
                const storageKey = 'ggb_' + key.replace(/[A-Z]/g, letter => '_' + letter.toLowerCase());
                localStorage.setItem(storageKey, value);
            });

            // 更新全局变量
            MAX_HISTORY_LENGTH = parseInt(settings.maxHistory) || 10;

            return settings;
        }

        function applySettings() {
            const settings = saveSettings();
            
            // 如果 GGB 已加载，实时应用设置
            if (isGGBReady && ggbApp) {
                // 显示/隐藏坐标轴
                const showAxes = settings.showAxes === 'true';
                ggbApp.setAxesVisible(showAxes, showAxes);
                
                // 显示/隐藏网格
                ggbApp.setGridVisible(settings.showGrid === 'true');
                
                // 设置字体（通过执行 GGB 指令）
                const fontFamily = settings.fontFamily.split(',')[0].trim();
                ggbApp.evalCommand(`SetVisibleInView[Text1, 1, false]`);  // 临时指令
                // 注意：字体设置可能需要重新初始化才能完全生效
                
                showToast('设置已应用', 'success');
            } else {
                showToast('设置已保存，将在下次加载时生效', 'info');
            }
        }

        function resetSettings() {
            if (!confirm('确定要恢复默认设置吗？')) return;
            
            // 清除所有设置
            Object.keys(defaultSettings).forEach(key => {
                const storageKey = 'ggb_' + key.replace(/[A-Z]/g, letter => '_' + letter.toLowerCase());
                localStorage.removeItem(storageKey);
            });
            
            // 重新加载默认值
            loadSettings();
            
            // 应用默认设置
            if (isGGBReady && ggbApp) {
                ggbApp.setAxesVisible(true, true);
                ggbApp.setGridVisible(true);
            }
            
            // 更新导出按钮文本
            updateExportButtonText();
            
            showToast('已恢复默认设置', 'success');
        }

        // 监听右侧面板设置变化自动保存
        ['right-show-axes', 'right-show-grid', 'right-font-family', 'right-font-size', 
         'right-context-memory', 'right-max-history', 'right-export-format', 
         'right-export-scale'].forEach(id => {
            const elem = document.getElementById(id);
            if (elem) {
                elem.addEventListener('change', (e) => {
                    // 自动保存到 localStorage
                    const storageKey = 'ggb_' + id.replace('right-', '').replace(/-([a-z])/g, (m, p1) => '_' + p1.toLowerCase());
                    localStorage.setItem(storageKey, e.target.value);
                    
                    if (id === 'right-export-format') {
                        updateExportButtonText();
                    }
                    
                    // 实时应用到GGB
                    if (isGGBReady && ggbApp && (id === 'right-show-axes' || id === 'right-show-grid')) {
                        if (id === 'right-show-axes') {
                            const show = e.target.value === 'true';
                            ggbApp.setAxesVisible(show, show);
                        } else {
                            ggbApp.setGridVisible(e.target.value === 'true');
                        }
                    }
                });
            }
        });

        // 更新导出按钮文本
        function updateExportButtonText() {
            const formatEl = document.getElementById('right-export-format');
            const format = formatEl ? formatEl.value : 'png';
            const target = 'download';  // 简化，默认下载
            
            const formatNames = {
                'png': 'PNG',
                'ggb': 'GGB'
            };
            
            const action = target === 'clipboard' ? '复制' : '导出';
            const type = formatNames[format] || '图片';
            
            document.getElementById('export-btn-text').textContent = `${action}${type}`;
        }

        // ========== 示例功能 ==========
        function setExample(text) {
            setInputValue('user-input', text);
            getEl('user-input')?.focus();
        }

        async function fileToDataUrl(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(new Error('读取图片失败'));
                reader.readAsDataURL(file);
            });
        }

        function renderPendingImagePreview() {
            const box = getEl('chat-image-preview');
            const img = getEl('chat-image-preview-img');
            const text = getEl('chat-image-preview-text');
            if (!box || !img || !text) return;

            if (!pendingImageDataUrl) {
                box.classList.remove('show');
                img.removeAttribute('src');
                text.textContent = '已粘贴图片';
                return;
            }

            img.src = pendingImageDataUrl;
            const kb = Math.max(1, Math.round((pendingImageDataUrl.length * 3 / 4) / 1024));
            const mime = pendingImageMimeType || 'image/*';
            text.textContent = `已粘贴图片（${mime}，约 ${kb} KB）`;
            box.classList.add('show');
        }

        function clearPendingImage() {
            pendingImageDataUrl = null;
            pendingImageMimeType = '';
            renderPendingImagePreview();
        }

        function initChatImagePasteSupport() {
            const input = getEl('user-input');
            if (!input) return;

            input.addEventListener('paste', async (event) => {
                const clipboard = event.clipboardData;
                if (!clipboard || !clipboard.items) return;

                const imageItem = Array.from(clipboard.items).find(item => item.type && item.type.startsWith('image/'));
                if (!imageItem) return;

                const file = imageItem.getAsFile();
                if (!file) return;

                try {
                    const dataUrl = await fileToDataUrl(file);
                    if (typeof dataUrl !== 'string' || !dataUrl.startsWith('data:image/')) {
                        throw new Error('图片格式不支持');
                    }
                    pendingImageDataUrl = dataUrl;
                    pendingImageMimeType = file.type || '';
                    renderPendingImagePreview();
                    showToast('图片已粘贴，可直接发送', 'success');
                } catch (e) {
                    showToast(`图片粘贴失败：${e.message}`, 'error');
                }
            });
        }

        // ========== 键盘事件 ==========
        function handleKeyDown(event) {
            // 输入法选词阶段按 Enter 不应触发发送
            if (event.isComposing || event.keyCode === 229) {
                return;
            }
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                generateGraphic();
            }
        }
        
        // 命令编辑器键盘快捷键
        function handleCommandEditorKeyDown(event) {
            const runHotkey = event.ctrlKey || event.metaKey;
            // Ctrl+Enter: 执行所有命令
            if (event.key === 'Enter' && runHotkey && !event.shiftKey) {
                event.preventDefault();
                executeCommands();
            }
            // Ctrl+Shift+Enter: 逐步执行
            else if (event.key === 'Enter' && runHotkey && event.shiftKey) {
                event.preventDefault();
                executeCommandsStepByStep();
            }
        }

        // ========== AI 生成逻辑 ==========
        function normalizeArkInputContent(messageContent) {
            if (Array.isArray(messageContent)) {
                return messageContent
                    .map(part => {
                        if (!part || typeof part !== 'object') return null;
                        if (part.type === 'text') {
                            const text = String(part.text || '').trim();
                            return text ? { type: 'input_text', text } : null;
                        }
                        if (part.type === 'image_url') {
                            const url = typeof part.image_url === 'string'
                                ? part.image_url
                                : part.image_url?.url;
                            return url ? { type: 'input_image', image_url: url } : null;
                        }
                        return null;
                    })
                    .filter(Boolean);
            }
            const text = String(messageContent || '').trim();
            return text ? [{ type: 'input_text', text }] : [];
        }

        function buildCompletionRequests(providerKey, apiBase, model, messages, temperature, maxTokens) {
            if (providerKey === 'doubao') {
                const safeMessages = Array.isArray(messages) ? messages : [];
                const instructions = safeMessages
                    .filter(msg => msg && msg.role === 'system')
                    .map(msg => (typeof msg.content === 'string' ? msg.content.trim() : ''))
                    .filter(Boolean)
                    .join('\n\n');

                const input = safeMessages
                    .filter(msg => msg && msg.role !== 'system')
                    .map(msg => ({
                        role: msg.role === 'assistant' ? 'assistant' : 'user',
                        content: normalizeArkInputContent(msg.content)
                    }))
                    .filter(msg => Array.isArray(msg.content) && msg.content.length > 0);

                const responsesReq = {
                    label: 'responses',
                    url: `${apiBase}/responses`,
                    body: {
                        model,
                        input,
                        temperature,
                        max_output_tokens: maxTokens,
                        ...(instructions ? { instructions } : {})
                    }
                };

                // 兜底回退：部分接入点只兼容 chat/completions
                const chatReq = {
                    label: 'chat_completions_fallback',
                    url: `${apiBase}/chat/completions`,
                    body: {
                        model,
                        messages: safeMessages,
                        temperature,
                        max_tokens: maxTokens
                    }
                };

                return [responsesReq, chatReq];
            }

            return [{
                label: 'chat_completions',
                url: `${apiBase}/chat/completions`,
                body: {
                    model,
                    messages,
                    temperature,
                    max_tokens: maxTokens
                }
            }];
        }

        function extractAssistantText(providerKey, data) {
            if (providerKey === 'doubao') {
                if (typeof data?.output_text === 'string' && data.output_text.trim()) {
                    return data.output_text.trim();
                }
                if (Array.isArray(data?.output)) {
                    const texts = [];
                    data.output.forEach(item => {
                        if (!item) return;
                        if (Array.isArray(item.content)) {
                            item.content.forEach(part => {
                                const t = part?.text || part?.output_text || '';
                                if (typeof t === 'string' && t.trim()) texts.push(t.trim());
                            });
                        } else if (typeof item.text === 'string' && item.text.trim()) {
                            texts.push(item.text.trim());
                        }
                    });
                    if (texts.length > 0) return texts.join('\n');
                }
            }

            const text = data?.choices?.[0]?.message?.content;
            if (typeof text === 'string' && text.trim()) {
                return text.trim();
            }
            throw new Error('未能从响应中解析出模型输出');
        }

        async function generateGraphic() {
            const input = getInputValue('user-input').trim();
            const imageDataUrl = pendingImageDataUrl;
            const hasImage = !!imageDataUrl;
            if (!input && !hasImage) {
                showToast('请输入描述内容或粘贴图片', 'warning');
                return;
            }

            // 获取 API 配置
            const savedKeys = JSON.parse(localStorage.getItem('ggb_provider_keys') || '{}');
            const apiKey = savedKeys[currentProvider] || '';
            const apiModel = localStorage.getItem('ggb_api_model') || '';
            
            // 获取服务商配置
            let apiBase = '';
            if (currentProvider.startsWith('custom_')) {
                const index = parseInt(currentProvider.replace('custom_', ''));
                apiBase = customProviders[index]?.baseUrl || '';
            } else {
                apiBase = API_PROVIDERS[currentProvider]?.baseUrl || '';
            }

            if (!apiBase || !apiKey || !apiModel) {
                showToast('请先配置 API 设置（点击右上角 ⚙️ 设置）', 'warning');
                toggleRightSettings();
                return;
            }

            // 添加用户消息到聊天UI
            addChatMessage('user', input || '（图片）', null, { imageDataUrl });
            setInputValue('user-input', '');
            clearPendingImage();

            // 显示加载状态
            const loadingId = addLoadingMessage();
            const sendBtn = document.getElementById('send-btn');
            sendBtn.disabled = true;

            try {
                // 检查是否开启上下文记忆
                const contextMemoryEl = document.getElementById('right-context-memory') || document.getElementById('context-memory');
                const contextMemory = (contextMemoryEl?.value || localStorage.getItem('ggb_context_memory') || 'on') === 'on';
                
                // 构建消息列表
                const messages = [
                    { role: 'system', content: buildSystemPrompt() }
                ];
                
                // 如果开启上下文记忆，添加历史对话
                if (contextMemory) {
                    const recentHistory = conversationHistory.slice(-MAX_HISTORY_LENGTH * 2);
                    messages.push(...recentHistory);
                }
                
                // 添加当前用户输入
                if (hasImage) {
                    messages.push({
                        role: 'user',
                        content: [
                            { type: 'text', text: input || '请根据图片生成 GeoGebra 作图指令。' },
                            { type: 'image_url', image_url: { url: imageDataUrl } }
                        ]
                    });
                } else {
                    messages.push({ role: 'user', content: input });
                }

                const requestPlans = buildCompletionRequests(currentProvider, apiBase, apiModel, messages, 0.3, 2000);
                let ggbCommands = '';
                const attemptErrors = [];

                for (const req of requestPlans) {
                    const response = await fetch(req.url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(req.body)
                    });

                    const raw = await response.text();
                    let data = {};
                    try {
                        data = raw ? JSON.parse(raw) : {};
                    } catch (e) {
                        data = {};
                    }

                    if (!response.ok) {
                        const msg = data?.error?.message || data?.message || raw || `HTTP ${response.status}`;
                        attemptErrors.push(`${req.label}: ${msg}`);
                        continue;
                    }

                    try {
                        ggbCommands = extractAssistantText(currentProvider, data);
                        if (ggbCommands) break;
                        attemptErrors.push(`${req.label}: 空响应`);
                    } catch (e) {
                        attemptErrors.push(`${req.label}: ${e.message}`);
                    }
                }

                if (!ggbCommands) {
                    throw new Error(attemptErrors.join(' | ') || '模型无可用输出');
                }

                // 保存对话历史
                conversationHistory.push(
                    { role: 'user', content: input || '[用户发送了一张图片]' },
                    { role: 'assistant', content: ggbCommands }
                );
                
                // 限制历史长度
                if (conversationHistory.length > MAX_HISTORY_LENGTH * 2) {
                    conversationHistory = conversationHistory.slice(-MAX_HISTORY_LENGTH * 2);
                }

                removeLoadingMessage(loadingId);
                
                // 提取命令（去掉markdown代码块标记）
                const cleanedCommands = ggbCommands
                    .replace(/```[\w]*\n?/g, '')
                    .replace(/```/g, '')
                    .trim();
                
                // 追加到命令编辑器（保留已有内容）
                setCommandEditorContent(cleanedCommands, { append: true });
                
                addChatMessage('ai', '✅ 命令已追加到编辑器！请在下方命令编辑器中查看、修改后点击「执行到画板」', ggbCommands);

            } catch (error) {
                removeLoadingMessage(loadingId);
                addChatMessage('ai', `生成失败：${error.message}`);
                showToast('生成失败：' + error.message, 'error');
            } finally {
                sendBtn.disabled = false;
            }
        }

        // ========== GGB 指令执行 ==========
        function executeGGBCommands(commands) {
            if (!isGGBReady || !ggbApp) {
                showToast('GeoGebra 尚未加载完成，请稍后再试', 'warning');
                console.warn('GGB not ready:', { isGGBReady, ggbApp });
                return;
            }

            const cleanedCommands = parseCommandLines(commands);
            const invalid = validateCommandsAgainstWhitelist(cleanedCommands);
            if (invalid.length > 0) {
                const preview = invalid.slice(0, 3).map(x => {
                    if (x.reason === 'reserved_builtin') {
                        return `第${x.lineNo}行: ${x.name}（内置对象不可重定义）`;
                    }
                    return `第${x.lineNo}行: ${x.name}`;
                }).join('；');
                showToast(`存在疑似不存在的指令，已拦截执行：${preview}`, 'error');
                console.warn('Blocked invalid commands:', invalid);
                return;
            }

            let successCount = 0;
            let failCount = 0;

            cleanedCommands.forEach(cmd => {
                try {
                    ggbApp.evalCommand(cmd);
                    commandHistory.push(cmd);
                    successCount++;
                } catch (e) {
                    console.warn('指令执行失败:', cmd, e);
                    failCount++;
                }
            });

            if (successCount > 0) {
                showToast(`成功执行 ${successCount} 条指令`, 'success');
            }
            if (failCount > 0) {
                showToast(`${failCount} 条指令执行失败`, 'warning');
            }
        }

        // ========== 命令编辑器功能 ==========

        function getCommandInputEl() {
            const el = document.getElementById('command-input');
            if (!el) {
                showToast('命令编辑器未就绪，请刷新页面重试', 'error');
                return null;
            }
            return el;
        }

        // 命令编辑器异常改写保护
        let commandEditorLastStableValue = '';
        let commandEditorWriteLock = false;
        let commandEditorFocused = false;
        let commandEditorGuardTimer = null;

        function withCommandEditorWrite(mutator) {
            const el = getCommandInputEl();
            if (!el) return;
            commandEditorWriteLock = true;
            try {
                mutator(el);
                commandEditorLastStableValue = el.value;
            } finally {
                setTimeout(() => {
                    commandEditorWriteLock = false;
                }, 0);
            }
        }

        function initCommandEditorGuard() {
            const el = getCommandInputEl();
            if (!el) return;

            commandEditorLastStableValue = el.value || '';

            el.addEventListener('focus', () => {
                commandEditorFocused = true;
            });
            el.addEventListener('blur', () => {
                commandEditorFocused = false;
                commandEditorLastStableValue = el.value || '';
            });
            el.addEventListener('input', () => {
                if (!commandEditorWriteLock) {
                    commandEditorLastStableValue = el.value || '';
                }
            });

            if (commandEditorGuardTimer) {
                clearInterval(commandEditorGuardTimer);
            }
            commandEditorGuardTimer = setInterval(() => {
                if (commandEditorWriteLock || commandEditorFocused) return;
                const current = el.value || '';
                // 未聚焦且出现异常缩短，回滚到最近稳定值
                if (current.length + 1 < commandEditorLastStableValue.length) {
                    el.value = commandEditorLastStableValue;
                    showToast('已拦截命令编辑器的异常删改', 'warning');
                    return;
                }
                commandEditorLastStableValue = current;
            }, 800);
        }

        function parseCommandLines(rawText) {
            return (rawText || '')
                .replace(/```[\w]*\n?/g, '')
                .replace(/```/g, '')
                .split('\n')
                .map(line => line.trim())
                .filter(line => line && !line.startsWith('//') && !line.startsWith('#') && !line.startsWith('--'));
        }

        const GGB_ALLOWED_COMMANDS = new Set([
            'Point', 'Intersect', 'Segment', 'Line', 'Ray', 'Vector',
            'Polygon', 'RegularPolygon', 'RigidPolygon', 'VectorPolygon',
            'Circle', 'Incircle', 'Ellipse', 'Hyperbola', 'Parabola',
            'Tangent', 'OrthogonalLine', 'PerpendicularLine', 'AngularBisector',
            'Semicircle', 'CircleArc', 'CircleSector', 'CircumcircleArc', 'CircumcircleSector',
            'Midpoint', 'Center'
        ]);

        const GGB_ALLOWED_MATH_FUNCS = new Set([
            'sin', 'cos', 'tan', 'asin', 'acos', 'atan', 'sqrt', 'abs',
            'ln', 'log', 'exp', 'floor', 'ceil', 'round',
            'min', 'max', 'sinh', 'cosh', 'tanh', 'sec', 'csc', 'cot'
        ]);
        const GGB_RESERVED_BUILTINS = new Set(['xAxis', 'yAxis']);

        function extractPrimaryCallName(cmdLine) {
            const line = String(cmdLine || '').trim();
            if (!line) return null;
            let expr = line;
            const eqIdx = line.indexOf('=');
            if (eqIdx >= 0) expr = line.slice(eqIdx + 1).trim();
            if (!expr) return null;
            const m = expr.match(/^([A-Za-z][A-Za-z0-9_]*)\s*\(/);
            return m ? m[1] : null;
        }

        function validateCommandsAgainstWhitelist(lines) {
            const invalid = [];
            (lines || []).forEach((line, idx) => {
                const eqIdx = line.indexOf('=');
                if (eqIdx > 0) {
                    const lhs = line.slice(0, eqIdx).trim();
                    if (GGB_RESERVED_BUILTINS.has(lhs)) {
                        invalid.push({
                            lineNo: idx + 1,
                            line,
                            name: lhs,
                            reason: 'reserved_builtin'
                        });
                        return;
                    }
                }
                const name = extractPrimaryCallName(line);
                if (!name) return;
                if (GGB_ALLOWED_COMMANDS.has(name)) return;
                if (GGB_ALLOWED_MATH_FUNCS.has(name.toLowerCase())) return;
                invalid.push({ lineNo: idx + 1, line, name });
            });
            return invalid;
        }

        function extractCommandsFromXML(xmlString) {
            try {
                const doc = new DOMParser().parseFromString(xmlString, 'text/xml');
                const construction = doc.querySelector('construction');
                if (!construction) return [];

                const lines = [];
                construction.querySelectorAll('command').forEach(cmd => {
                    const name = cmd.getAttribute('name');
                    const input = cmd.querySelector('input');
                    if (!name || !input) return;

                    const args = [];
                    for (let i = 0; ; i++) {
                        const v = input.getAttribute(`a${i}`);
                        if (v === null) break;
                        args.push(v);
                    }
                    if (args.length > 0) {
                        lines.push(`${name}(${args.join(', ')})`);
                    }
                });
                return lines;
            } catch (e) {
                console.warn('extractCommandsFromXML failed:', e);
                return [];
            }
        }

        function formatConicEquation(eq) {
            if (!eq) return '';
            return String(eq)
                // x^(2) -> x^2
                .replace(/\^\(\s*([^)]+?)\s*\)/g, '^$1')
                // (4 * x) -> 4x, (a * y) -> ay
                .replace(/\(\s*([A-Za-z0-9.]+)\s*\*\s*([A-Za-z])\s*\)/g, '$1$2')
                // 4 * x -> 4x
                .replace(/\b([0-9.]+)\s*\*\s*([A-Za-z])\b/g, '$1$2')
                // x * y 保留为 xy（GeoGebra 可识别）
                .replace(/\b([A-Za-z])\s*\*\s*([A-Za-z])\b/g, '$1$2')
                // / 两侧去空格：x^2 / 16 -> x^2/16
                .replace(/\s*\/\s*/g, '/')
                // 清理多余空白
                .replace(/\s+/g, ' ')
                .trim();
        }
        
        // 执行命令编辑器中的所有命令
        function executeCommands() {
            const commandInput = getCommandInputEl();
            if (!commandInput) return;
            const commands = commandInput.value.trim();
            
            if (!commands) {
                showToast('命令编辑器为空，请先输入或粘贴命令', 'warning');
                return;
            }
            
            if (!isGGBReady || !ggbApp) {
                showToast('GeoGebra 尚未加载完成', 'warning');
                return;
            }
            
            executeGGBCommands(commands);
        }
        
        // 逐步执行命令（每行之间有延迟，便于观察）
        async function executeCommandsStepByStep() {
            const commandInput = getCommandInputEl();
            if (!commandInput) return;
            const commands = commandInput.value.trim();
            
            if (!commands) {
                showToast('命令编辑器为空', 'warning');
                return;
            }
            
            if (!isGGBReady || !ggbApp) {
                showToast('GeoGebra 尚未加载完成', 'warning');
                return;
            }
            
            const lines = parseCommandLines(commands);
            const invalid = validateCommandsAgainstWhitelist(lines);
            if (invalid.length > 0) {
                const preview = invalid.slice(0, 3).map(x => {
                    if (x.reason === 'reserved_builtin') {
                        return `第${x.lineNo}行: ${x.name}（内置对象不可重定义）`;
                    }
                    return `第${x.lineNo}行: ${x.name}`;
                }).join('；');
                showToast(`存在疑似不存在的指令，已拦截执行：${preview}`, 'error');
                console.warn('Blocked invalid commands:', invalid);
                return;
            }
            
            let executed = 0;
            const total = lines.length;
            
            showToast(`开始逐步执行，共 ${total} 条命令...`, 'info');
            
            for (const cmd of lines) {
                try {
                    ggbApp.evalCommand(cmd);
                    commandHistory.push(cmd);
                    executed++;
                    showToast(`执行 ${executed}/${total}: ${cmd.substring(0, 30)}...`, 'info');
                    await sleep(500); // 500ms 延迟便于观察
                } catch (e) {
                    console.warn('指令执行失败:', cmd, e);
                    showToast(`执行失败: ${cmd}`, 'error');
                }
            }
            
            showToast(`逐步执行完成，成功 ${executed}/${total}`, 'success');
        }
        
        // 清空命令编辑器
        function clearCommandEditor() {
            const commandInput = getCommandInputEl();
            if (!commandInput) return;
            if (commandInput.value.trim() && !confirm('确定要清空命令编辑器吗？')) {
                return;
            }
            withCommandEditorWrite((el) => {
                el.value = '';
            });
            showToast('命令编辑器已清空', 'info');
        }
        
        // 从GGB画板读取当前命令
        function readCommandsFromGGB() {
            if (!isGGBReady || !ggbApp) {
                showToast('GeoGebra 尚未加载完成', 'warning');
                return;
            }
            
            try {
                // 获取所有对象的XML定义并解析为命令
                const xml = ggbApp.getXML ? ggbApp.getXML() : '';
                if (!xml) {
                    showToast('无法获取画板数据', 'warning');
                    return;
                }
                
                // 使用解析器提取命令
                const parser = new GGBParser(xml);
                const data = parser.parse();
                
                let commands = [];
                
                // 从解析结果重建命令
                if (data.structured) {
                    // 点
                    data.structured.points?.forEach(p => {
                        if (p.visible) {
                            commands.push(`${p.label} = (${p.x.toFixed(2)}, ${p.y.toFixed(2)})`);
                        }
                    });
                    
                    // 函数
                    data.structured.functions?.forEach(f => {
                        if (f.visible && f.exp) {
                            commands.push(f.exp);
                        }
                    });
                    
                    // 线段
                    data.structured.segments?.forEach(s => {
                        if (s.fromPolygon) return;
                        if (s.visible) {
                            if (s.startLabel && s.endLabel) {
                                commands.push(`Segment(${s.startLabel}, ${s.endLabel})`);
                            }
                        }
                    });

                    // 多边形
                    data.structured.polygons?.forEach(p => {
                        if (!p.visible) return;
                        if (p.commandName && Array.isArray(p.commandInputs) && p.commandInputs.length >= 3) {
                            const polyCmd = `${p.commandName}(${p.commandInputs.join(', ')})`;
                            if (!commands.includes(polyCmd)) {
                                commands.push(polyCmd);
                            }
                        }
                    });

                    // 向量
                    data.structured.vectors?.forEach(v => {
                        if (!v.visible) return;
                        if (v.commandName && Array.isArray(v.commandInputs) && v.commandInputs.length >= 2) {
                            const vecCmd = `${v.commandName}(${v.commandInputs.join(', ')})`;
                            if (!commands.includes(vecCmd)) {
                                commands.push(vecCmd);
                            }
                        } else if (v.startLabel && v.endLabel) {
                            const vecCmd = `Vector(${v.startLabel}, ${v.endLabel})`;
                            if (!commands.includes(vecCmd)) {
                                commands.push(vecCmd);
                            }
                        }
                    });

                    // 射线
                    data.structured.rays?.forEach(r => {
                        if (!r.visible) return;
                        if (r.commandName && Array.isArray(r.commandInputs) && r.commandInputs.length > 0) {
                            const rayCmd = `${r.commandName}(${r.commandInputs.join(', ')})`;
                            if (!commands.includes(rayCmd)) {
                                commands.push(rayCmd);
                            }
                        } else if (r.startLabel && r.throughLabel) {
                            const rayCmd = `Ray(${r.startLabel}, ${r.throughLabel})`;
                            if (!commands.includes(rayCmd)) {
                                commands.push(rayCmd);
                            }
                        }
                    });
                    
                    // 直线
                    data.structured.lines?.forEach(l => {
                        if (l.visible) {
                            if (l.commandName && Array.isArray(l.commandInputs) && l.commandInputs.length > 0) {
                                const lineCmd = `${l.commandName}(${l.commandInputs.join(', ')})`;
                                if (!commands.includes(lineCmd)) {
                                    commands.push(lineCmd);
                                }
                            } else if (l.point1Label && l.point2Label) {
                                const lineCmd = `Line(${l.point1Label}, ${l.point2Label})`;
                                if (!commands.includes(lineCmd)) {
                                    commands.push(lineCmd);
                                }
                            } else if (l.point1Coord && l.point2Coord) {
                                const lineCmd = `Line((${l.point1Coord.x}, ${l.point1Coord.y}), (${l.point2Coord.x}, ${l.point2Coord.y}))`;
                                if (!commands.includes(lineCmd)) {
                                    commands.push(lineCmd);
                                }
                            }
                        }
                    });
                    
                    // 圆锥曲线
                    data.structured.conics?.forEach(c => {
                        if (!c.visible) return;
                        switch (c.conicType) {
                            case 'circle':
                                if (c.centerLabel && c.passLabel) {
                                    commands.push(`Circle(${c.centerLabel}, ${c.passLabel})`);
                                } else if (c.centerCoord && c.passCoord) {
                                    commands.push(`Circle((${c.centerCoord.x}, ${c.centerCoord.y}), (${c.passCoord.x}, ${c.passCoord.y}))`);
                                } else if (c.centerLabel && typeof c.radius === 'number') {
                                    commands.push(`Circle(${c.centerLabel}, ${c.radius})`);
                                } else if (c.centerCoord && typeof c.radius === 'number') {
                                    commands.push(`Circle((${c.centerCoord.x}, ${c.centerCoord.y}), ${c.radius})`);
                                }
                                break;
                            case 'ellipse':
                                if (c.focus1Label && c.focus2Label && c.passLabel) {
                                    commands.push(`Ellipse(${c.focus1Label}, ${c.focus2Label}, ${c.passLabel})`);
                                } else if (c.focus1Coord && c.focus2Coord && c.passCoord) {
                                    commands.push(`Ellipse((${c.focus1Coord.x}, ${c.focus1Coord.y}), (${c.focus2Coord.x}, ${c.focus2Coord.y}), (${c.passCoord.x}, ${c.passCoord.y}))`);
                                } else if (c.focus1Coord && c.focus2Coord && c.majorAxisLength) {
                                    commands.push(`Ellipse((${c.focus1Coord.x}, ${c.focus1Coord.y}), (${c.focus2Coord.x}, ${c.focus2Coord.y}), ${c.majorAxisLength})`);
                                }
                                break;
                            case 'hyperbola':
                                if (c.focus1Label && c.focus2Label && c.passLabel) {
                                    commands.push(`Hyperbola(${c.focus1Label}, ${c.focus2Label}, ${c.passLabel})`);
                                } else if (c.focus1Coord && c.focus2Coord && c.passCoord) {
                                    commands.push(`Hyperbola((${c.focus1Coord.x}, ${c.focus1Coord.y}), (${c.focus2Coord.x}, ${c.focus2Coord.y}), (${c.passCoord.x}, ${c.passCoord.y}))`);
                                } else if (c.focus1Coord && c.focus2Coord && c.majorAxisLength) {
                                    commands.push(`Hyperbola((${c.focus1Coord.x}, ${c.focus1Coord.y}), (${c.focus2Coord.x}, ${c.focus2Coord.y}), ${c.majorAxisLength})`);
                                }
                                break;
                            case 'parabola':
                                if (c.focusCoord && c.directrix) {
                                    commands.push(`Parabola((${c.focusCoord.x}, ${c.focusCoord.y}), ${c.directrix})`);
                                }
                                break;
                            default:
                                if (c.commandName && Array.isArray(c.commandInputs) && c.commandInputs.length > 0) {
                                    commands.push(`${c.commandName}(${c.commandInputs.join(', ')})`);
                                } else if (c.equation && c.label) {
                                    commands.push(`${c.label}: ${formatConicEquation(c.equation)}`);
                            }
                                break;
                        }
                    });

                    // 圆弧/扇形
                    data.structured.conicparts?.forEach(cp => {
                        if (!cp.visible) return;
                        if (cp.commandName && Array.isArray(cp.commandInputs) && cp.commandInputs.length > 0) {
                            const cpCmd = `${cp.commandName}(${cp.commandInputs.join(', ')})`;
                            if (!commands.includes(cpCmd)) {
                                commands.push(cpCmd);
                            }
                        }
                    });
                }
                
                // 兜底：直接从 XML command 序列提取（覆盖更多命令类型）
                const xmlCommands = extractCommandsFromXML(xml);
                if (xmlCommands.length > commands.length) {
                    commands = xmlCommands;
                } else if (commands.length === 0 && xmlCommands.length > 0) {
                    commands = xmlCommands;
                }

                if (commands.length === 0) {
                    showToast('未读取到可重建命令（可能当前对象不支持）', 'warning');
                    return;
                }

                withCommandEditorWrite((el) => {
                    el.value = commands.join('\n');
                });
                showToast(`已读取 ${commands.length} 条命令`, 'success');
                
            } catch (err) {
                showToast('读取失败: ' + err.message, 'error');
                console.error(err);
            }
        }
        
        // 设置命令编辑器内容（供AI调用）
        function setCommandEditorContent(commands, options = {}) {
            const commandInput = getCommandInputEl();
            if (!commandInput) return;
            const normalized = (commands || '').replace(/\r\n/g, '\n').trim();
            if (!normalized) return;

            const append = !!options.append;
            if (!append) {
                withCommandEditorWrite((el) => {
                    el.value = normalized;
                });
            } else {
                const current = commandInput.value.trim();
                if (!current) {
                    withCommandEditorWrite((el) => {
                        el.value = normalized;
                    });
                } else {
                    const divider = `\n\n-- AI 追加 ${new Date().toLocaleTimeString()}\n`;
                    withCommandEditorWrite((el) => {
                        el.value = `${current}${divider}${normalized}`;
                    });
                }
            }
            // 自动滚动到底部
            commandInput.scrollTop = commandInput.scrollHeight;
        }
        
        // 获取命令编辑器内容
        function getCommandEditorContent() {
            return getInputValue('command-input');
        }
        
        // 辅助函数：延迟
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ========== 聊天历史管理 ==========
        function addChatMessage(role, content, code = null, options = {}) {
            const historyContainer = document.getElementById('chat-history');
            const emptyState = historyContainer.querySelector('.empty-state');
            if (emptyState) emptyState.remove();

            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}`;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'user' ? '👤' : '🤖';

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.textContent = content;

            if (options && options.imageDataUrl) {
                const image = document.createElement('img');
                image.src = options.imageDataUrl;
                image.alt = '用户上传图片';
                image.style.maxWidth = '220px';
                image.style.maxHeight = '220px';
                image.style.display = 'block';
                image.style.marginTop = '8px';
                image.style.borderRadius = '8px';
                image.style.border = '1px solid var(--border-color)';
                bubble.appendChild(image);
            }

            if (code) {
                const codeBlock = document.createElement('div');
                codeBlock.className = 'code-block';
                codeBlock.innerHTML = `
                    <div class="code-header">
                        <span>GeoGebra 指令</span>
                        <button class="code-copy" onclick="copyCode(this)">复制</button>
                    </div>
                    <pre><code>${escapeHtml(code)}</code></pre>
                `;
                bubble.appendChild(codeBlock);
            }

            const meta = document.createElement('div');
            meta.className = 'message-meta';
            meta.textContent = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(bubble);
            messageDiv.appendChild(meta);
            historyContainer.appendChild(messageDiv);

            historyContainer.scrollTop = historyContainer.scrollHeight;
            chatHistoryData.push({ role, content, code, imageDataUrl: options?.imageDataUrl || null, time: Date.now() });
        }

        function addLoadingMessage() {
            const historyContainer = document.getElementById('chat-history');
            const emptyState = historyContainer.querySelector('.empty-state');
            if (emptyState) emptyState.remove();

            const id = 'loading-' + Date.now();
            const messageDiv = document.createElement('div');
            messageDiv.id = id;
            messageDiv.className = 'chat-message ai';
            messageDiv.innerHTML = `
                <div class="message-avatar">🤖</div>
                <div class="message-bubble loading-bubble">
                    <div class="loading-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            historyContainer.appendChild(messageDiv);
            historyContainer.scrollTop = historyContainer.scrollHeight;
            return id;
        }

        function removeLoadingMessage(id) {
            const elem = document.getElementById(id);
            if (elem) elem.remove();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function copyCode(btn) {
            try {
                const code = btn.closest('.code-block').querySelector('code').textContent;
                await navigator.clipboard.writeText(code);
                btn.textContent = '已复制!';
                setTimeout(() => btn.textContent = '复制', 2000);
            } catch (err) {
                showToast('复制失败，请手动复制', 'error');
            }
        }

        // ========== 工具栏功能 ==========
        // 快速复制指令到剪贴板
        async function copyCommandsToClipboard() {
            if (commandHistory.length === 0) {
                showToast('暂无指令可复制', 'warning');
                return;
            }

            try {
                const content = commandHistory.join('\n');
                await navigator.clipboard.writeText(content);
                showToast('指令已复制到剪贴板', 'success');
            } catch (err) {
                showToast('复制失败：' + err.message, 'error');
            }
        }

        // 清空对话历史
        function clearConversation() {
            if (conversationHistory.length === 0) {
                showToast('当前没有对话历史', 'info');
                return;
            }

            if (confirm('确定要清空 AI 对话历史吗？\n注意：这不会清除已绘制的图形，只是让 AI 忘记之前的对话上下文。')) {
                conversationHistory = [];
                showToast('对话历史已清空，AI 将开始新的对话', 'success');
                
                // 在聊天区添加提示
                addChatMessage('ai', '💡 对话历史已重置。现在您可以开始一个新的图形项目，AI 会基于当前画布状态继续工作。');
            }
        }

        async function exportCommands() {
            if (commandHistory.length === 0) {
                showToast('暂无指令可导出', 'warning');
                return;
            }

            const content = commandHistory.join('\n');
            const target = localStorage.getItem('ggb_export_target') || 'download';

            if (target === 'clipboard') {
                // 复制到剪贴板
                await navigator.clipboard.writeText(content);
                showToast('指令已复制到剪贴板', 'success');
            } else {
                // 下载文件
                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `geogebra-commands-${Date.now()}.txt`;
                a.click();
                URL.revokeObjectURL(url);
                showToast('指令已导出', 'success');
            }
        }

        async function exportImage() {
            if (!isGGBReady || !ggbApp) {
                showToast('GeoGebra 尚未加载完成', 'warning');
                return;
            }

            // 读取用户设置（从 localStorage 或右侧面板）
            const format = localStorage.getItem('ggb_export_format') || 'png';
            const scale = parseFloat(localStorage.getItem('ggb_export_scale')) || 2;
            const transparent = localStorage.getItem('ggb_export_transparent') === 'true';
            const target = localStorage.getItem('ggb_export_target') || 'download';

            try {
                switch (format) {
                    case 'png':
                        await exportPNG(scale, transparent, target);
                        break;
                    case 'ggb':
                        await exportGGB(target);
                        break;
                    default:
                        showToast('不支持的导出格式', 'error');
                }
            } catch (e) {
                showToast('导出失败：' + e.message, 'error');
            }
        }

        // 导出 PNG
        async function exportPNG(scale, transparent, target) {
            const pngBase64 = ggbApp.getPNGBase64(scale, transparent);
            const dataUrl = 'data:image/png;base64,' + pngBase64;
            const filename = `geogebra-graphic-${Date.now()}.png`;

            if (target === 'clipboard') {
                // 复制到剪贴板
                try {
                    // 检查浏览器是否支持 ClipboardItem
                    if (typeof ClipboardItem !== 'undefined') {
                        const blob = await fetch(dataUrl).then(r => r.blob());
                        await navigator.clipboard.write([
                            new ClipboardItem({ 'image/png': blob })
                        ]);
                        showToast(`PNG 图片已复制到剪贴板 (${scale}x)`, 'success');
                    } else {
                        // 降级：复制 base64 数据
                        await navigator.clipboard.writeText(dataUrl);
                        showToast('图片 Base64 已复制（浏览器不支持直接复制图片）', 'info');
                    }
                } catch (err) {
                    // 降级：直接下载
                    showToast('剪贴板复制失败，已转为下载', 'warning');
                    const a = document.createElement('a');
                    a.href = dataUrl;
                    a.download = filename;
                    a.click();
                }
            } else {
                // 下载文件
                const a = document.createElement('a');
                a.href = dataUrl;
                a.download = filename;
                a.click();
                showToast(`PNG 图片已下载 (${scale}x)`, 'success');
            }
        }

// 当前处理的元素数据（全局缓存）
        let currentProcessedData = null;

        // 显示画板元素（预处理后的数据）
        function showBoardElements() {
            if (!isGGBReady || !ggbApp) {
                showToast('GeoGebra 尚未加载完成', 'warning');
                return;
            }

            try {
                // 获取 XML 数据
                let xmlData = '';
                if (ggbApp.getXML) {
                    xmlData = ggbApp.getXML();
                } else if (ggbApp.getGGBFile) {
                    xmlData = ggbApp.getGGBFile();
                }

                if (!xmlData) {
                    showToast('无法获取 XML 数据', 'error');
                    return;
                }

                // 预处理
                const processed = preprocessGGBXML(xmlData);
                currentProcessedData = processed;

                // 打开元素查看器
                openElementsViewer(processed);
            } catch (e) {
                console.error('获取画板元素失败:', e);
                showToast('获取画板元素失败：' + e.message, 'error');
            }
        }

        // 预处理 GGB XML 数据（按用户规则）
        // 使用 GGBParser 解析 XML
        function preprocessGGBXML(xmlString) {
            if (typeof GGBParser === 'undefined') {
                console.error('GGBParser not loaded');
                return { elements: [], stats: { total: 0, visible: 0, byType: {} }, rawXML: xmlString };
            }
            const parser = new GGBParser(xmlString);
            return parser.parse();
        }

// 打开元素查看器
        function openElementsViewer(data) {
            const modal = document.getElementById('elements-viewer-modal');
            const statsDiv = document.getElementById('elements-stats');
            const listDiv = document.getElementById('elements-list');
            const jsonDiv = document.getElementById('json-preview');
            
            if (!modal) return;
            
            // 渲染统计（简化为只显示总数和分类）
            if (statsDiv) {
                const s = data.structured;
                statsDiv.innerHTML = `
                    <div style="background: var(--bg-tertiary); padding: var(--space-3); border-radius: var(--radius); text-align: center;">
                        <div style="font-size: 20px;">📍</div>
                        <div style="font-size: 18px; font-weight: 600;">${s.points?.length || 0}</div>
                        <div style="font-size: 11px; color: var(--text-tertiary);">点</div>
                    </div>
                    <div style="background: var(--bg-tertiary); padding: var(--space-3); border-radius: var(--radius); text-align: center;">
                        <div style="font-size: 20px;">📈</div>
                        <div style="font-size: 18px; font-weight: 600;">${s.functions?.length || 0}</div>
                        <div style="font-size: 11px; color: var(--text-tertiary);">函数</div>
                    </div>
                    <div style="background: var(--bg-tertiary); padding: var(--space-3); border-radius: var(--radius); text-align: center;">
                        <div style="font-size: 20px;">━</div>
                        <div style="font-size: 18px; font-weight: 600;">${s.segments?.length || 0}</div>
                        <div style="font-size: 11px; color: var(--text-tertiary);">线段</div>
                    </div>
                    <div style="background: var(--bg-tertiary); padding: var(--space-3); border-radius: var(--radius); text-align: center;">
                        <div style="font-size: 20px;">⬠</div>
                        <div style="font-size: 18px; font-weight: 600;">${s.polygons?.length || 0}</div>
                        <div style="font-size: 11px; color: var(--text-tertiary);">多边形</div>
                    </div>
                    <div style="background: var(--bg-tertiary); padding: var(--space-3); border-radius: var(--radius); text-align: center;">
                        <div style="font-size: 20px;">⇀</div>
                        <div style="font-size: 18px; font-weight: 600;">${s.vectors?.length || 0}</div>
                        <div style="font-size: 11px; color: var(--text-tertiary);">向量</div>
                    </div>
                    <div style="background: var(--bg-tertiary); padding: var(--space-3); border-radius: var(--radius); text-align: center;">
                        <div style="font-size: 20px;">↗</div>
                        <div style="font-size: 18px; font-weight: 600;">${s.rays?.length || 0}</div>
                        <div style="font-size: 11px; color: var(--text-tertiary);">射线</div>
                    </div>
                    <div style="background: var(--bg-tertiary); padding: var(--space-3); border-radius: var(--radius); text-align: center;">
                        <div style="font-size: 20px;">╍</div>
                        <div style="font-size: 18px; font-weight: 600;">${s.lines?.length || 0}</div>
                        <div style="font-size: 11px; color: var(--text-tertiary);">直线</div>
                    </div>
                    <div style="background: var(--bg-tertiary); padding: var(--space-3); border-radius: var(--radius); text-align: center;">
                        <div style="font-size: 20px;">○</div>
                        <div style="font-size: 18px; font-weight: 600;">${s.conics?.length || 0}</div>
                        <div style="font-size: 11px; color: var(--text-tertiary);">圆锥曲线</div>
                    </div>
                    <div style="background: var(--bg-tertiary); padding: var(--space-3); border-radius: var(--radius); text-align: center;">
                        <div style="font-size: 20px;">◔</div>
                        <div style="font-size: 18px; font-weight: 600;">${s.conicparts?.length || 0}</div>
                        <div style="font-size: 11px; color: var(--text-tertiary);">圆弧/扇形</div>
                    </div>
                    <div style="background: var(--bg-tertiary); padding: var(--space-3); border-radius: var(--radius); text-align: center;">
                        <div style="font-size: 20px;">📦</div>
                        <div style="font-size: 18px; font-weight: 600;">${s.others?.length || 0}</div>
                        <div style="font-size: 11px; color: var(--text-tertiary);">其他</div>
                    </div>
                `;
            }
            
            // 渲染元素列表（传入整个 data 对象，让 renderElementsList 使用 structured）
            renderElementsList(listDiv, data);
            
            // 渲染 JSON 预览（使用新的 structured 结构）
            if (jsonDiv) {
                jsonDiv.textContent = JSON.stringify(data.structured, null, 2);
            }
            
            modal.classList.add('show');
        }

        // 渲染统计
        function renderStats(container, stats, summary) {
            const typeIcons = {
                point: '📍',
                segment: '━',
                line: '╍',
                ray: '▶',
                circle: '○',
                polygon: '⬡',
                conic: '∿',
                function: '📈',
                angle: '∠',
                text: '📝',
                vector: '⇀'
            };
            
            let html = `
                <div class="stat-card" style="background: var(--bg-tertiary); padding: var(--space-3); border-radius: var(--radius); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 4px;">📊</div>
                    <div style="font-size: 18px; font-weight: 600; color: var(--text-primary);">${stats.total}</div>
                    <div style="font-size: 11px; color: var(--text-tertiary);">总对象</div>
                </div>
                <div class="stat-card" style="background: var(--bg-tertiary); padding: var(--space-3); border-radius: var(--radius); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 4px;">👁️</div>
                    <div style="font-size: 18px; font-weight: 600; color: var(--success);">${stats.visible}</div>
                    <div style="font-size: 11px; color: var(--text-tertiary);">可见</div>
                </div>
            `;
            
            // 按类型统计
            for (const [type, count] of Object.entries(stats.byType).sort((a, b) => b[1] - a[1])) {
                html += `
                    <div class="stat-card" style="background: var(--bg-tertiary); padding: var(--space-3); border-radius: var(--radius); text-align: center;">
                        <div style="font-size: 20px; margin-bottom: 4px;">${typeIcons[type] || '📦'}</div>
                        <div style="font-size: 16px; font-weight: 600; color: var(--text-primary);">${count}</div>
                        <div style="font-size: 10px; color: var(--text-tertiary); text-transform: uppercase;">${type}</div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        // 渲染元素列表（按类型分组显示）
        function renderElementsList(container, data) {
            const structured = data.structured || {};
            let html = '';
            
            // 辅助函数：渲染单个组
            function renderGroup(title, items, icon) {
                if (!items || items.length === 0) return '';
                
                let groupHtml = `
                    <div style="margin-bottom: var(--space-3);">
                        <div style="padding: var(--space-2) var(--space-3); background: var(--bg-tertiary); font-weight: 600; font-size: 12px; color: var(--text-secondary); display: flex; align-items: center; gap: var(--space-2);">
                            <span>${icon}</span>
                            <span>${title}</span>
                            <span style="margin-left: auto; color: var(--text-tertiary);">${items.length}</span>
                        </div>
                `;
                
                items.forEach((el, idx) => {
                    const globalIndex = `${title}-${idx}`;
                    const visibility = el.visible ? 
                        '<span style="color: var(--success); font-size: 10px;">●</span>' : 
                        '<span style="color: var(--text-tertiary); font-size: 10px;">○</span>';
                    
                    // 根据类型显示摘要（改进版）
                    let summary = '';
                    if (el.type === 'point') {
                        summary = `(${el.x?.toFixed(2) || '?'}, ${el.y?.toFixed(2) || '?'})`;
                    } else if (el.type === 'function') {
                        summary = el.exp || '无表达式';
                    } else if (el.type === 'segment') {
                        summary = formatSegmentSummary(el);
                    } else if (el.type === 'polygon') {
                        summary = formatPolygonSummary(el);
                    } else if (el.type === 'vector') {
                        summary = formatVectorSummary(el);
                    } else if (el.type === 'ray') {
                        summary = formatRaySummary(el);
                    } else if (el.type === 'line') {
                        summary = formatLineSummary(el);
                    } else if (el.type === 'conic') {
                        summary = formatConicSummary(el);
                    } else if (el.type === 'conicpart') {
                        summary = formatConicPartSummary(el);
                    }
                    
                    groupHtml += `
                        <div class="element-item" style="border-bottom: 1px solid var(--border-color);">
                            <div onclick="toggleElementDetail('${globalIndex}')" style="display: flex; align-items: center; padding: var(--space-2) var(--space-3); font-size: 13px; cursor: pointer;">
                                <span style="font-weight: 500; color: var(--text-primary); min-width: 60px;">${el.label}</span>
                                <span style="color: var(--text-secondary); flex: 1; font-family: 'JetBrains Mono', monospace; font-size: 11px; margin-left: var(--space-2); overflow: hidden; text-overflow: ellipsis;">${summary}</span>
                                <span style="margin-left: var(--space-2);">${visibility}</span>
                                <span id="expand-${globalIndex}" style="margin-left: var(--space-2); color: var(--text-tertiary); font-size: 10px;">▼</span>
                            </div>
                            <div id="detail-${globalIndex}" style="display: none;">
                                <div style="padding: var(--space-3); background: #0f172a; border-top: 1px solid var(--border-color);">
                                    <div style="margin-bottom: var(--space-2); color: #64748b; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px;">📄 原始 XML</div>
                                    <pre style="margin: 0; padding: var(--space-3); background: #1e293b; color: #e2e8f0; font-family: 'JetBrains Mono', monospace; font-size: 11px; line-height: 1.6; overflow-x: auto; white-space: pre; border-radius: var(--radius-sm);">${escapeHtml(el.rawXML)}</pre>
                                </div>
                                <details style="border-top: 1px solid var(--border-color);">
                                    <summary style="padding: var(--space-2) var(--space-3); color: var(--text-secondary); font-size: 11px; cursor: pointer; background: var(--bg-secondary);">🔧 解析后数据 (JSON)</summary>
                                    <pre style="margin: 0; padding: var(--space-3); background: #1e293b; color: #94a3b8; font-family: 'JetBrains Mono', monospace; font-size: 10px; line-height: 1.5; overflow-x: auto; white-space: pre-wrap;">${escapeHtml(JSON.stringify(el, null, 2))}</pre>
                                </details>
                            </div>
                        </div>
                    `;
                });
                
                groupHtml += '</div>';
                return groupHtml;
            }
            
            // 按顺序渲染各组
            html += renderGroup('点 (Points)', structured.points, '📍');
            html += renderGroup('函数 (Functions)', structured.functions, '📈');
            html += renderGroup('线段 (Segments)', structured.segments, '━');
            html += renderGroup('多边形 (Polygons)', structured.polygons, '⬠');
            html += renderGroup('向量 (Vectors)', structured.vectors, '⇀');
            html += renderGroup('射线 (Rays)', structured.rays, '↗');
            html += renderGroup('直线 (Lines)', structured.lines, '╍');
            html += renderGroup('圆锥曲线 (Conics)', structured.conics, '○');
            html += renderGroup('圆弧/扇形 (ConicParts)', structured.conicparts, '◔');
            html += renderGroup('其他 (Others)', structured.others, '📦');
            
            container.innerHTML = html || '<div style="padding: var(--space-4); text-align: center; color: var(--text-tertiary);">暂无元素</div>';
        }

        // 格式化线段摘要
        function formatSegmentSummary(el) {
            if (el.fromPolygon && el.polygonLabel) {
                if (el.startLabel && el.endLabel) return `${el.startLabel} → ${el.endLabel}（${el.polygonLabel} 的边）`;
                return `${el.polygonLabel} 的边`;
            }
            if (el.startLabel && el.endLabel) {
                return `${el.startLabel} → ${el.endLabel}`;
            } else if (el.startCoord && el.endCoord) {
                return `(${el.startCoord.x.toFixed(1)},${el.startCoord.y.toFixed(1)}) → (${el.endCoord.x.toFixed(1)},${el.endCoord.y.toFixed(1)})`;
            }
            return '端点信息不完整';
        }

        function formatPolygonSummary(el) {
            const verts = (el.vertices || []).map(v => v.label).filter(Boolean);
            if (verts.length >= 3) return verts.join(' → ');
            if (Array.isArray(el.commandInputs) && el.commandInputs.length >= 3) return el.commandInputs.join(' → ');
            return '多边形';
        }

        function formatVectorSummary(el) {
            if (el.startLabel && el.endLabel) return `${el.startLabel} → ${el.endLabel}`;
            if (el.startLabel && Number.isFinite(el.vx) && Number.isFinite(el.vy)) {
                return `${el.startLabel} + (${el.vx.toFixed(2)}, ${el.vy.toFixed(2)})`;
            }
            if (el.startCoord && el.endCoord) {
                return `(${el.startCoord.x.toFixed(1)},${el.startCoord.y.toFixed(1)}) → (${el.endCoord.x.toFixed(1)},${el.endCoord.y.toFixed(1)})`;
            }
            return '向量';
        }

        // 格式化直线摘要
        function formatLineSummary(el) {
            if (el.point1Label && el.point2Label) {
                return `过 ${el.point1Label}, ${el.point2Label}`;
            } else if (el.a !== undefined) {
                return `${el.a.toFixed(1)}x + ${el.b.toFixed(1)}y + ${el.c.toFixed(1)} = 0`;
            }
            return '方程信息不完整';
        }

        function formatRaySummary(el) {
            if (el.startLabel && el.throughLabel) {
                return `起点 ${el.startLabel}，过 ${el.throughLabel}`;
            }
            if (el.a !== undefined && el.b !== undefined && el.c !== undefined) {
                return `${el.a.toFixed(1)}x + ${el.b.toFixed(1)}y + ${el.c.toFixed(1)} = 0`;
            }
            return '射线信息不完整';
        }

        // 格式化圆锥曲线摘要
        function formatConicSummary(el) {
            const type = el.conicType || 'conic';
            const semantic = el.normalized?.semanticType || el.semanticType || '';
            if (semantic) {
                return `${type} · ${semantic}`;
            }
            if (type === 'circle') {
                if (el.centerLabel) return `圆心:${el.centerLabel}`;
                if (el.centerCoord) return `圆心:(${el.centerCoord.x.toFixed(1)},${el.centerCoord.y.toFixed(1)})`;
            } else if (type === 'ellipse') {
                return '椭圆';
            } else if (type === 'parabola') {
                return '抛物线';
            } else if (type === 'hyperbola') {
                return '双曲线';
            }
            return type;
        }

        function formatConicPartSummary(el) {
            if (el.commandName === 'Semicircle') {
                if (el.point1Label && el.point2Label) return `半圆(${el.point1Label}, ${el.point2Label})`;
                return '半圆';
            }
            if (el.commandName === 'CircleSector') {
                if (el.centerLabel && el.startLabel && el.endLabel) {
                    return `扇形(${el.centerLabel}, ${el.startLabel}, ${el.endLabel})`;
                }
                return '圆扇形';
            }
            if (el.commandName === 'CircleArc') {
                if (el.centerLabel && el.startLabel && el.endLabel) {
                    return `圆弧(${el.centerLabel}, ${el.startLabel}, ${el.endLabel})`;
                }
                return '圆弧';
            }
            if (el.commandName === 'CircumcircleArc') {
                if (el.p1Label && el.p2Label && el.p3Label) {
                    return `外接圆弧(${el.p1Label}, ${el.p2Label}, ${el.p3Label})`;
                }
                return '外接圆弧';
            }
            if (el.commandName === 'CircumcircleSector') {
                if (el.p1Label && el.p2Label && el.p3Label) {
                    return `外接扇形(${el.p1Label}, ${el.p2Label}, ${el.p3Label})`;
                }
                return '外接扇形';
            }
            return el.commandName || 'conicpart';
        }

        // 切换元素详情展开/收起
        function toggleElementDetail(id) {
            const detail = document.getElementById(`detail-${id}`);
            const icon = document.getElementById(`expand-${id}`);
            if (detail && icon) {
                const isVisible = detail.style.display !== 'none';
                detail.style.display = isVisible ? 'none' : 'block';
                icon.textContent = isVisible ? '▼' : '▲';
            }
        }

        // HTML 转义函数
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getProcessedDebugPayload() {
            if (!currentProcessedData) return null;
            return {
                meta: {
                    version: '1.0',
                    exportedAt: new Date().toISOString(),
                    mode: 'semantic+resolved'
                },
                stats: currentProcessedData.stats || {},
                structured: currentProcessedData.structured || {},
                semantics: currentProcessedData.semantics || {},
                notes: [
                    'structured: 按对象类型分组的原始解析结果',
                    'semantics: 面向 TikZ/调试的关系与派生点',
                    '优先使用显式命名点（Intersect/Foot 等）保证可复现'
                ]
            };
        }

        // 关闭元素查看器
        function closeElementsViewer() {
            const modal = document.getElementById('elements-viewer-modal');
            if (modal) modal.classList.remove('show');
        }

        // 复制处理后的 JSON
        async function copyProcessedJSON() {
            if (!currentProcessedData) return;
            
            try {
                const payload = getProcessedDebugPayload();
                await navigator.clipboard.writeText(JSON.stringify(payload, null, 2));
                showToast('调试 JSON 已复制到剪贴板', 'success');
            } catch (e) {
                showToast('复制失败', 'error');
            }
        }

        // 下载处理后的 JSON
        function downloadProcessedJSON() {
            if (!currentProcessedData) return;
            
            const payload = getProcessedDebugPayload();
            const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `geogebra-debug-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('调试 JSON 文件已下载', 'success');
        }

        // 显示完整原始 XML
        function showFullRawXML() {
            if (!currentProcessedData || !currentProcessedData.rawXML) {
                showToast('没有可用的 XML 数据', 'warning');
                return;
            }
            
            // 创建一个新的模态框显示完整 XML
            const modal = document.createElement('div');
            modal.className = 'modal-overlay show';
            modal.style.zIndex = '3000';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 95vw; max-height: 90vh; width: 1200px;">
                    <div class="modal-header">
                        <h3>📄 完整原始 XML 数据</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                    </div>
                    <div class="modal-body" style="padding: 0;">
                        <pre style="margin: 0; padding: var(--space-4); background: #0f172a; color: #e2e8f0; font-family: 'JetBrains Mono', monospace; font-size: 11px; line-height: 1.5; overflow: auto; max-height: 70vh; white-space: pre;">${escapeHtml(currentProcessedData.rawXML)}</pre>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="copyFullXML()">📋 复制</button>
                        <button class="btn btn-secondary" onclick="downloadFullXML()">💾 下载</button>
                        <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">关闭</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // 添加复制和下载功能
            window.copyFullXML = function() {
                navigator.clipboard.writeText(currentProcessedData.rawXML);
                showToast('已复制到剪贴板', 'success');
            };
            window.downloadFullXML = function() {
                const blob = new Blob([currentProcessedData.rawXML], { type: 'application/xml;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `geogebra-raw-${Date.now()}.xml`;
                a.click();
                URL.revokeObjectURL(url);
                showToast('已下载', 'success');
            };
        }

        function buildTikZFromBoard() {
            if (!isGGBReady || !ggbApp) {
                throw new Error('GeoGebra 尚未加载完成');
            }
            if (typeof TikZGenerator === 'undefined') {
                throw new Error('TikZ 生成器未加载');
            }
            const xml = ggbApp.getXML ? ggbApp.getXML() : '';
            if (!xml) {
                throw new Error('无法获取画板 XML');
            }
            const processed = preprocessGGBXML(xml);
            currentProcessedData = processed;
            const bounds = deriveTikZBoundsFromData(processed, {
                xmin: -2.3, xmax: 2.8, ymin: -2.6, ymax: 2.4
            });

            const generator = new TikZGenerator({
                strictStatic: true,
                semanticFirst: false,
                useSourceStyle: false,
                defaultStrokeColor: 'black',
                defaultStrokeThickness: 'thick',
                defaultPointColor: 'black',
                definePointCoordinates: true,
                lineExtensionStart: 0.25,
                lineExtensionEnd: 0.25,
                axis: true,
                grid: false,
                xmin: bounds.xmin, xmax: bounds.xmax,
                ymin: bounds.ymin, ymax: bounds.ymax,
                width: '12cm',
                height: '12cm',
                outputMode: 'figure',
                tikzScale: 1.2,
                tikzPictureOptions: '>=Stealth',
                figureCaption: '图片标题',
                figureLabel: 'fig:标签'
            });
            return generator.generate(processed);
        }

        function deriveTikZBoundsFromData(processed, fallback) {
            const points = processed?.structured?.points || [];
            const visible = points.filter(p => p && p.visible && Number.isFinite(Number(p.x)) && Number.isFinite(Number(p.y)));
            if (visible.length === 0) return fallback;

            let xmin = Infinity, xmax = -Infinity, ymin = Infinity, ymax = -Infinity;
            visible.forEach(p => {
                const x = Number(p.x);
                const y = Number(p.y);
                xmin = Math.min(xmin, x);
                xmax = Math.max(xmax, x);
                ymin = Math.min(ymin, y);
                ymax = Math.max(ymax, y);
            });

            let dx = xmax - xmin;
            let dy = ymax - ymin;
            if (dx < 1e-6) dx = 2;
            if (dy < 1e-6) dy = 2;
            const padX = Math.max(0.8, dx * 0.2);
            const padY = Math.max(0.8, dy * 0.2);

            return {
                xmin: Number((xmin - padX).toFixed(2)),
                xmax: Number((xmax + padX).toFixed(2)),
                ymin: Number((ymin - padY).toFixed(2)),
                ymax: Number((ymax + padY).toFixed(2))
            };
        }

        // 生成 TikZ 代码（预览弹窗）
        function generateTikZ() {
            try {
                showToast('正在生成 TikZ 代码...', 'info');
                const tikzCode = buildTikZFromBoard();
                showTikZModal(tikzCode);
            } catch (err) {
                showToast('生成失败: ' + err.message, 'error');
                console.error(err);
            }
        }

        // 快速导出 TikZ（默认复制到剪贴板）
        async function exportTikZToClipboard() {
            try {
                const tikzCode = buildTikZFromBoard();
                await navigator.clipboard.writeText(tikzCode);
                showToast('TikZ 代码已复制到剪贴板', 'success');
            } catch (err) {
                showToast('导出 TikZ 失败: ' + err.message, 'error');
                console.error(err);
            }
        }
        
        // 显示 TikZ 代码弹窗
        function showTikZModal(code) {
            // 创建弹窗
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: var(--bg-primary, #1e293b);
                    border-radius: 12px;
                    width: 90%;
                    max-width: 800px;
                    max-height: 80vh;
                    display: flex;
                    flex-direction: column;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                ">
                    <div style="
                        padding: 16px 20px;
                        border-bottom: 1px solid var(--border-color, #334155);
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    ">
                        <h3 style="margin: 0; font-size: 16px; color: var(--text-primary, #f8fafc);">🎨 TikZ 代码</h3>
                        <div>
                            <button id="copy-tikz" style="
                                background: var(--primary, #6366f1);
                                color: white;
                                border: none;
                                padding: 8px 16px;
                                border-radius: 6px;
                                cursor: pointer;
                                margin-right: 8px;
                            ">📋 复制</button>
                            <button id="download-tikz" style="
                                background: var(--success, #10b981);
                                color: white;
                                border: none;
                                padding: 8px 16px;
                                border-radius: 6px;
                                cursor: pointer;
                                margin-right: 8px;
                            ">💾 下载</button>
                            <button id="close-tikz" style="
                                background: transparent;
                                color: var(--text-secondary, #cbd5e1);
                                border: 1px solid var(--border-color, #334155);
                                padding: 8px 16px;
                                border-radius: 6px;
                                cursor: pointer;
                            ">✕</button>
                        </div>
                    </div>
                    <div style="padding: 0;">
                        <textarea id="tikz-code" readonly style="
                            width: 100%;
                            height: 60vh;
                            background: var(--bg-secondary, #0f172a);
                            color: var(--text-primary, #f8fafc);
                            border: none;
                            padding: 20px;
                            font-family: 'Consolas', 'Monaco', monospace;
                            font-size: 13px;
                            line-height: 1.6;
                            resize: none;
                            outline: none;
                        ">${escapeHtml(code)}</textarea>
                    </div>
                    <div style="
                        padding: 12px 20px;
                        border-top: 1px solid var(--border-color, #334155);
                        font-size: 12px;
                        color: var(--text-tertiary, #94a3b8);
                    ">
                        提示: 本地模板生成适合标准图形，如需 AI 优化请在对话框中发送"生成 TikZ"
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 事件绑定
            modal.querySelector('#close-tikz').onclick = () => modal.remove();
            modal.querySelector('#copy-tikz').onclick = async () => {
                try {
                    await navigator.clipboard.writeText(code);
                    showToast('TikZ 代码已复制', 'success');
                } catch (e) {
                    showToast('复制失败', 'error');
                }
            };
            modal.querySelector('#download-tikz').onclick = () => {
                const blob = new Blob([code], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `geogebra-tikz-${Date.now()}.tex`;
                a.click();
                URL.revokeObjectURL(url);
                showToast('TikZ 文件已下载', 'success');
            };
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
        }

        // 导出 GGB 源文件
        async function exportGGB(target) {
            // 获取 GGB base64 数据
            let ggbBase64 = null;
            
            if (ggbApp.getBase64) {
                ggbBase64 = ggbApp.getBase64();
            } else if (ggbApp.getGGBFile) {
                ggbBase64 = ggbApp.getGGBFile();
            }

            if (!ggbBase64) {
                showToast('当前版本不支持 GGB 导出', 'warning');
                return;
            }

            const filename = `geogebra-project-${Date.now()}.ggb`;

            if (target === 'clipboard') {
                // GGB 文件太大，不适合剪贴板，提示下载
                showToast('GGB 文件较大，已转为下载', 'info');
                const a = document.createElement('a');
                a.href = 'data:application/vnd.geogebra.file;base64,' + ggbBase64;
                a.download = filename;
                a.click();
            } else {
                // 下载文件
                const a = document.createElement('a');
                a.href = 'data:application/vnd.geogebra.file;base64,' + ggbBase64;
                a.download = filename;
                a.click();
                showToast('GGB 源文件已下载', 'success');
            }
        }

        function showCommands() {
            if (commandHistory.length === 0) {
                showToast('暂无指令', 'info');
                return;
            }
            
            const commands = commandHistory.join('\n');
            addChatMessage('ai', '当前已执行的指令：', commands);
            showToast('指令已显示在左侧面板', 'info');
        }

        function clearBoard(resetAll = false) {
            if (!isGGBReady || !ggbApp) {
                showToast('GeoGebra 尚未加载完成', 'warning');
                return;
            }

            // 全部重置模式
            if (resetAll) {
                if (confirm('确定要全部重置吗？\n这将清除所有图形和 AI 对话历史，无法恢复。')) {
                    ggbApp.reset();
                    commandHistory = [];
                    conversationHistory = [];
                    showToast('画板和对话历史已全部重置', 'success');
                }
                return;
            }

            // 仅清除画板
            if (confirm('确定要清除画板吗？所有图形将被删除。')) {
                ggbApp.reset();
                commandHistory = [];
                showToast('画板已清除', 'success');
            }
        }

        // 清空命令编辑器和画板
        function clearCommandAndBoard() {
            if (!isGGBReady || !ggbApp) {
                showToast('GeoGebra 尚未加载完成', 'warning');
                return;
            }

            if (confirm('确定要清空画布和代码吗？\n这将删除所有图形和命令编辑器中的代码。')) {
                // 清空画板
                ggbApp.reset();
                commandHistory = [];
                
                // 清空命令编辑器
                withCommandEditorWrite((el) => {
                    el.value = '';
                });
                
                showToast('画布和代码已清空', 'success');
            }
        }

        function undoCommand() {
            if (!isGGBReady || !ggbApp) {
                showToast('GeoGebra 尚未加载完成', 'warning');
                return;
            }

            try {
                // 使用 GGB API 的 undo 方法
                if (typeof ggbApp.undo === 'function') {
                    ggbApp.undo();
                    // 同时更新本地指令历史
                    if (commandHistory.length > 0) {
                        commandHistory.pop();
                    }
                    showToast('已撤销上一步', 'info');
                } else {
                    showToast('当前版本不支持撤销功能', 'warning');
                }
            } catch (e) {
                console.error('撤销失败:', e);
                showToast('撤销失败，请使用 GeoGebra 工具栏的撤销按钮', 'warning');
            }
        }



        // ========== Toast 提示 ==========
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };
            
            toast.innerHTML = `<span>${icons[type]}</span><span>${message}</span>`;
            container.appendChild(toast);

            setTimeout(() => toast.remove(), 3000);
        }

        // ========== 拖拽调整宽度 ==========
        function initResizer() {
            const resizer = document.getElementById('resizer');
            const leftPanel = document.querySelector('.left-panel');
            let isResizing = false;
            let startX = 0;
            let startWidth = 0;

            resizer.addEventListener('mousedown', (e) => {
                isResizing = true;
                startX = e.clientX;
                startWidth = leftPanel.offsetWidth;
                resizer.classList.add('resizing');
                
                // 创建遮罩防止 iframe 拦截鼠标事件
                const mask = document.createElement('div');
                mask.className = 'resize-mask';
                mask.id = 'resize-mask';
                document.body.appendChild(mask);
                
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                
                const diff = e.clientX - startX;
                let newWidth = startWidth + diff;
                
                // 限制最小和最大宽度
                const minWidth = 300;
                const maxWidth = 600;
                newWidth = Math.max(minWidth, Math.min(maxWidth, newWidth));
                
                leftPanel.style.width = newWidth + 'px';
            });

            document.addEventListener('mouseup', () => {
                if (!isResizing) return;
                
                isResizing = false;
                resizer.classList.remove('resizing');
                
                // 移除遮罩
                const mask = document.getElementById('resize-mask');
                if (mask) mask.remove();
                
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
                
                // 保存宽度到 localStorage
                localStorage.setItem('ggb_left_panel_width', leftPanel.offsetWidth);
            });
        }

        // 中间面板拖拽调整
        function initCenterResizer() {
            const resizer2 = document.getElementById('resizer2');
            const centerPanel = document.getElementById('center-panel');
            
            if (!resizer2 || !centerPanel) return;
            
            let isResizing = false;
            let startX = 0;
            let startWidth = 0;

            resizer2.addEventListener('mousedown', (e) => {
                isResizing = true;
                startX = e.clientX;
                startWidth = centerPanel.offsetWidth;
                resizer2.classList.add('resizing');
                
                // 创建遮罩防止 iframe 拦截鼠标事件
                const mask = document.createElement('div');
                mask.className = 'resize-mask';
                mask.id = 'resize-mask2';
                document.body.appendChild(mask);
                
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                
                const diff = e.clientX - startX;
                let newWidth = startWidth + diff;
                
                // 限制最小和最大宽度
                const minWidth = 350;
                const maxWidth = 800;
                newWidth = Math.max(minWidth, Math.min(maxWidth, newWidth));
                
                centerPanel.style.width = newWidth + 'px';
            });

            document.addEventListener('mouseup', () => {
                if (!isResizing) return;
                
                isResizing = false;
                resizer2.classList.remove('resizing');
                
                // 移除遮罩
                const mask = document.getElementById('resize-mask2');
                if (mask) mask.remove();
                
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
                
                // 保存宽度到 localStorage
                localStorage.setItem('ggb_center_panel_width', centerPanel.offsetWidth);
            });
        }

        function loadPanelWidth() {
            // 加载左侧面板宽度
            const savedLeftWidth = localStorage.getItem('ggb_left_panel_width');
            if (savedLeftWidth) {
                const leftPanel = document.querySelector('.left-panel');
                if (leftPanel) leftPanel.style.width = savedLeftWidth + 'px';
            }
            
            // 加载中间面板宽度
            const savedCenterWidth = localStorage.getItem('ggb_center_panel_width');
            if (savedCenterWidth) {
                const centerPanel = document.getElementById('center-panel');
                if (centerPanel) centerPanel.style.width = savedCenterWidth + 'px';
            }
        }

        // ========== API 服务商管理 ==========

        function getModelGroupName(modelId) {
            const id = (modelId || '').toLowerCase();
            if (!id) return '其他';
            if (id.includes('/')) return (modelId.split('/')[0] || '其他').toUpperCase();
            if (id.startsWith('gpt-') || id.startsWith('o1') || id.startsWith('o3') || id.startsWith('text-')) return 'OpenAI';
            if (id.startsWith('deepseek')) return 'DeepSeek';
            if (id.startsWith('qwen')) return 'Qwen';
            if (id.startsWith('claude')) return 'Claude';
            if (id.startsWith('gemini')) return 'Gemini';
            if (id.startsWith('glm')) return 'GLM';
            if (id.startsWith('moonshot') || id.startsWith('kimi')) return 'Kimi';
            if (id.startsWith('doubao')) return 'Doubao';
            if (id.startsWith('llama') || id.includes('llama')) return 'Llama';
            return '其他';
        }

        const modelGroupCollapseState = {};
        const providerModelsMemory = {};

        function renderModelOptions(selectEl, models, placeholder, providerKey = currentProvider) {
            if (!selectEl) return;

            providerModelsMemory[providerKey] = models.slice();
            selectEl.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = placeholder || `选择模型 (${models.length}个可用)`;
            selectEl.appendChild(defaultOption);
            const manualOption = document.createElement('option');
            manualOption.value = '__manual__';
            manualOption.textContent = '✏️ 手动输入模型 ID...';
            selectEl.appendChild(manualOption);

            const grouped = new Map();
            models.forEach(model => {
                const id = model.id || model.value;
                const name = model.name || model.label || model.id || model.value;
                const group = getModelGroupName(id);
                if (!grouped.has(group)) grouped.set(group, []);
                grouped.get(group).push({ id, name });
            });

            const shouldGroup = models.length >= 12 && grouped.size > 1;
            if (!shouldGroup) {
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id || model.value;
                    option.textContent = model.name || model.label || model.id || model.value;
                    selectEl.appendChild(option);
                });
                return;
            }

            const groupOrder = Array.from(grouped.keys()).sort((a, b) => {
                if (a === '其他') return 1;
                if (b === '其他') return -1;
                return a.localeCompare(b);
            });

            if (!modelGroupCollapseState[providerKey]) {
                modelGroupCollapseState[providerKey] = {};
            }

            groupOrder.forEach(groupName => {
                const collapsed = !!modelGroupCollapseState[providerKey][groupName];
                const groupOption = document.createElement('option');
                groupOption.value = `__group__${groupName}`;
                groupOption.textContent = `${collapsed ? '▶' : '▼'} ${groupName} (${grouped.get(groupName).length})`;
                selectEl.appendChild(groupOption);

                if (collapsed) return;

                grouped.get(groupName).sort((a, b) => a.id.localeCompare(b.id)).forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = `   ${item.name}`;
                    selectEl.appendChild(option);
                });
            });
        }

        function handleModelSelectChange(event) {
            const select = event.target;
            const value = select?.value || '';
            if (value === '__manual__') {
                const typed = prompt('请输入模型 ID（火山方舟通常是“推理接入点 ID”）', localStorage.getItem('ggb_api_model') || '');
                if (typed && typed.trim()) {
                    const modelId = typed.trim();
                    let option = Array.from(select.options).find(o => o.value === modelId);
                    if (!option) {
                        option = document.createElement('option');
                        option.value = modelId;
                        option.textContent = `   ${modelId}`;
                        select.appendChild(option);
                    }
                    select.value = modelId;
                    saveApiSettings();
                    showToast('模型 ID 已保存', 'success');
                } else {
                    select.value = '';
                }
                return;
            }
            if (!value.startsWith('__group__')) {
                saveApiSettings();
                return;
            }

            const groupName = value.replace('__group__', '');
            if (!modelGroupCollapseState[currentProvider]) {
                modelGroupCollapseState[currentProvider] = {};
            }
            modelGroupCollapseState[currentProvider][groupName] = !modelGroupCollapseState[currentProvider][groupName];

            const models = providerModelsMemory[currentProvider] || [];
            renderModelOptions(select, models, `选择模型 (${models.length}个可用)`, currentProvider);
            select.value = '';
        }
        
        // 加载自定义服务商
        function loadCustomProviders() {
            const saved = localStorage.getItem('ggb_custom_providers');
            if (saved) {
                try {
                    customProviders = JSON.parse(saved);
                } catch (e) {
                    customProviders = [];
                }
            }
        }

        // 渲染服务商列表
        function renderProviderList() {
            const savedProvider = localStorage.getItem('ggb_api_provider') || 'openai';
            currentProvider = savedProvider;
            
            let html = '';
            
            // 内置服务商
            for (const [key, provider] of Object.entries(API_PROVIDERS)) {
                const isActive = key === savedProvider;
                html += `
                    <div class="provider-item ${isActive ? 'active' : ''}" onclick="selectProvider('${key}')">
                        <span class="provider-icon">${provider.icon}</span>
                        <span class="provider-name">${provider.name}</span>
                    </div>
                `;
            }
            
            // 自定义服务商
            customProviders.forEach((provider, index) => {
                const key = `custom_${index}`;
                const isActive = key === savedProvider;
                html += `
                    <div class="provider-item ${isActive ? 'active' : ''}" onclick="selectProvider('${key}')">
                        <span class="provider-icon">⚙️</span>
                        <span class="provider-name">${escapeHtml(provider.name)}</span>
                        <button class="provider-delete-btn" onclick="event.stopPropagation(); deleteCustomProvider(${index})" title="删除">&times;</button>
                    </div>
                `;
            });
            
            // 添加按钮
            html += `
                <div class="provider-item add-provider-btn" onclick="openAddProviderModal()">
                    <span class="provider-icon">+</span>
                    <span class="provider-name">添加自定义</span>
                </div>
            `;
            
            // 渲染到右侧面板
            const rightList = document.getElementById('right-provider-list');
            if (rightList) {
                rightList.innerHTML = html;
            }
            
            // 加载选中服务商的配置
            if (savedProvider.startsWith('custom_')) {
                const index = parseInt(savedProvider.replace('custom_', ''));
                loadCustomProviderConfig(index);
            } else {
                loadProviderConfig(savedProvider);
            }
        }

        // 选择服务商
        function selectProvider(providerKey) {
            currentProvider = providerKey;
            localStorage.setItem('ggb_api_provider', providerKey);
            
            // 更新列表选中状态
            document.querySelectorAll('.provider-item').forEach(item => {
                item.classList.remove('active');
            });
            const target = event ? event.currentTarget : document.querySelector(`[onclick="selectProvider('${providerKey}')"]`);
            if (target) target.classList.add('active');
            
            // 加载配置
            if (providerKey.startsWith('custom_')) {
                const index = parseInt(providerKey.replace('custom_', ''));
                loadCustomProviderConfig(index);
            } else {
                loadProviderConfig(providerKey);
            }
        }

        // 加载自定义服务商配置
        function loadCustomProviderConfig(index) {
            const provider = customProviders[index];
            if (!provider) return;
            
            const rightHintDiv = document.getElementById('right-api-key-hint');
            const rightStatusSpan = document.getElementById('right-model-status');
            const rightKeyStatusSpan = document.getElementById('right-api-key-status');
            const rightApiKey = document.getElementById('right-api-key');
            const rightModelSelect = document.getElementById('right-api-model');
            
            // 设置密钥提示
            if (rightHintDiv) rightHintDiv.textContent = '输入此服务商的 API 密钥，点击 ✓ 检测';
            
            // 重置检测状态
            if (rightKeyStatusSpan) {
                rightKeyStatusSpan.textContent = '';
                rightKeyStatusSpan.className = 'api-key-status';
            }
            
            // 加载保存的密钥
            const savedKeys = JSON.parse(localStorage.getItem('ggb_provider_keys') || '{}');
            const providerKey = `custom_${index}`;
            const key = savedKeys[providerKey] || '';
            if (rightApiKey) rightApiKey.value = key;
            
            // 设置模型列表
            if (rightModelSelect) {
                rightModelSelect.innerHTML = '';
                rightModelSelect.disabled = false;
                if (rightStatusSpan) rightStatusSpan.textContent = '';
                
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '输入密钥后获取模型列表';
                rightModelSelect.appendChild(defaultOption);
            }
            
            // 尝试加载模型
            if (key) {
                loadModelListForCustomProvider(index, key);
            }
        }

        // 为自定义服务商加载模型列表
        async function loadModelListForCustomProvider(index, apiKey) {
            const provider = customProviders[index];
            const rightModelSelect = document.getElementById('right-api-model');
            const rightStatusSpan = document.getElementById('right-model-status');
            
            if (!provider.baseUrl || !apiKey) return;
            
            if (rightStatusSpan) rightStatusSpan.textContent = '（加载中...）';
            if (rightModelSelect) {
                rightModelSelect.innerHTML = '<option value="">正在获取模型...</option>';
                rightModelSelect.disabled = true;
            }
            
            try {
                const models = await fetchModelsFromAPI(provider, apiKey);
                
                if (rightModelSelect) {
                    rightModelSelect.innerHTML = '';
                    rightModelSelect.disabled = false;
                    
                    if (models.length > 0) {
                        renderModelOptions(rightModelSelect, models, `选择模型 (${models.length}个可用)`, `custom_${index}`);
                    } else {
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = '未获取到模型，可手动输入';
                        rightModelSelect.appendChild(option);
                    }
                }
            } catch (e) {
                if (rightModelSelect) {
                    rightModelSelect.innerHTML = '';
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = '获取失败，可手动输入模型名';
                    rightModelSelect.appendChild(option);
                    rightModelSelect.disabled = false;
                }
            }
            
            if (rightStatusSpan) rightStatusSpan.textContent = '';
        }

        // 打开添加自定义服务商模态框
        function openAddProviderModal() {
            const modal = document.getElementById('add-provider-modal');
            if (modal) {
                modal.classList.add('show');
                document.getElementById('new-provider-name').focus();
            }
        }

        // 关闭添加自定义服务商模态框
        function closeAddProviderModal() {
            const modal = document.getElementById('add-provider-modal');
            if (modal) {
                modal.classList.remove('show');
                // 清空表单
                setInputValue('new-provider-name', '');
                setInputValue('new-provider-url', '');
            }
        }

        // 保存新的自定义服务商
        function saveNewProvider() {
            const name = getInputValue('new-provider-name').trim();
            const baseUrl = getInputValue('new-provider-url').trim();
            
            if (!name) {
                showToast('请输入服务商名称', 'warning');
                return;
            }
            if (!baseUrl) {
                showToast('请输入 API 地址', 'warning');
                return;
            }
            
            // 验证 URL 格式
            if (!baseUrl.startsWith('http')) {
                showToast('API 地址必须以 http:// 或 https:// 开头', 'warning');
                return;
            }
            
            // 添加新服务商
            customProviders.push({
                name: name,
                baseUrl: baseUrl,
                modelsEndpoint: '/models',
                defaultModels: []
            });
            
            // 保存
            localStorage.setItem('ggb_custom_providers', JSON.stringify(customProviders));
            
            // 刷新列表并选中新添加的
            renderProviderList();
            const newIndex = customProviders.length - 1;
            selectProvider(`custom_${newIndex}`);
            
            closeAddProviderModal();
            showToast(`已添加自定义服务商「${name}」`, 'success');
        }

        // 删除自定义服务商
        function deleteCustomProvider(index) {
            const provider = customProviders[index];
            if (!confirm(`确定要删除自定义服务商「${provider.name}」吗？`)) return;
            
            // 如果删除的是当前使用的，切换到默认
            const currentKey = localStorage.getItem('ggb_api_provider');
            if (currentKey === `custom_${index}`) {
                localStorage.setItem('ggb_api_provider', 'openai');
            }
            
            customProviders.splice(index, 1);
            localStorage.setItem('ggb_custom_providers', JSON.stringify(customProviders));
            
            renderProviderList();
            showToast('自定义服务商已删除', 'success');
        }

        // 手动触发刷新（用于按钮点击）
        async function manualRefreshModels() {
            await refreshModelList();
        }

        // 加载服务商配置
        async function loadProviderConfig(providerKey) {
            const provider = API_PROVIDERS[providerKey];
            if (!provider) return;
            
            const rightHintDiv = document.getElementById('right-api-key-hint');
            
            // 设置密钥提示
            if (rightHintDiv) {
                rightHintDiv.textContent = provider.keyHint || '输入 API 密钥，点击 ✓ 检测';
            }
            
            // 重置检测状态
            const keyStatusSpan = document.getElementById('right-api-key-status');
            if (keyStatusSpan) {
                keyStatusSpan.textContent = '';
                keyStatusSpan.className = 'api-key-status';
            }
            
            // 加载该服务商独立的密钥
            const savedKeys = JSON.parse(localStorage.getItem('ggb_provider_keys') || '{}');
            const key = savedKeys[providerKey] || '';
            const rightApiKey = document.getElementById('right-api-key');
            if (rightApiKey) rightApiKey.value = key;
            
            // 加载模型列表
            await loadModelList(providerKey);
        }

        // 加载模型列表（优先从 API 获取，失败则使用默认）
        async function loadModelList(providerKey) {
            const provider = API_PROVIDERS[providerKey];
            const rightModelSelect = document.getElementById('right-api-model');
            const rightApiKey = document.getElementById('right-api-key');
            const apiKey = rightApiKey ? rightApiKey.value.trim() : '';
            
            // 显示加载状态
            const statusSpan = document.getElementById('right-model-status');
            const hintDiv = document.getElementById('right-model-hint');
            if (statusSpan) statusSpan.textContent = '（加载中...）';
            
            if (rightModelSelect) {
                rightModelSelect.innerHTML = '<option value="">正在获取可用模型...</option>';
                rightModelSelect.disabled = true;
            }
            
            // provider 不存在时给出明确兜底，避免页面一直停留在“加载中”
            if (!provider) {
                if (rightModelSelect) {
                    rightModelSelect.innerHTML = '<option value="">服务商配置异常，请重新选择</option>';
                    rightModelSelect.disabled = false;
                }
                if (statusSpan) statusSpan.textContent = '';
                if (hintDiv) hintDiv.textContent = '当前服务商不可用，请重新选择';
                return;
            }

            // 尝试从缓存加载
            const cacheKey = `ggb_models_${providerKey}`;
            const cachedModels = localStorage.getItem(cacheKey);
            const cacheTime = localStorage.getItem(`${cacheKey}_time`);
            const isCacheValid = cacheTime && (Date.now() - parseInt(cacheTime)) < 24 * 60 * 60 * 1000;

            let models = [];
            let fetchedFromApi = false;

            try {
                // 如果有 API Key 且服务商支持，尝试从 API 获取
                if (apiKey && provider.modelsEndpoint && !provider.skipModelFetch) {
                    try {
                        models = await fetchModelsFromAPI(provider, apiKey);
                        if (models.length > 0) {
                            fetchedFromApi = true;
                            localStorage.setItem(cacheKey, JSON.stringify(models));
                            localStorage.setItem(`${cacheKey}_time`, Date.now().toString());
                        }
                    } catch (e) {
                        console.warn('从 API 获取模型列表失败:', e);
                    }
                }

                // 如果 API 获取失败或没有 Key，使用缓存或默认列表
                if (models.length === 0) {
                    if (isCacheValid && cachedModels) {
                        try {
                            models = JSON.parse(cachedModels);
                        } catch (e) {
                            models = [];
                        }
                    }
                    if (models.length === 0 && provider.defaultModels) {
                        models = provider.defaultModels.map(m => ({
                            id: m.id || m.value,
                            name: m.name || m.label || m.id || m.value
                        }));
                    }
                }
            } finally {
                // 无论成功失败，都结束“加载中”状态
                if (rightModelSelect) {
                    rightModelSelect.innerHTML = '';
                    rightModelSelect.disabled = false;
                }
                if (statusSpan) statusSpan.textContent = '';
            }

            if (models.length > 0 && rightModelSelect) {
                renderModelOptions(rightModelSelect, models, `选择模型 (${models.length}个可用)`, providerKey);

                const savedModel = localStorage.getItem('ggb_api_model');
                if (savedModel && models.find(m => (m.id || m.value) === savedModel)) {
                    rightModelSelect.value = savedModel;
                }

                if (hintDiv) {
                    const source = fetchedFromApi ? '已从 API 获取' : '使用默认/缓存列表';
                    if (providerKey === 'doubao') {
                        hintDiv.textContent = '豆包建议填写推理接入点 ID 作为模型；若默认模型不可用请手动替换';
                    } else {
                        hintDiv.textContent = `${source} · 点击 🔄 刷新`;
                    }
                }
            } else if (rightModelSelect) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = provider.editable ? '输入模型名称' : '请输入 API 密钥获取模型列表';
                rightModelSelect.appendChild(option);

                if (hintDiv) hintDiv.textContent = provider.editable ? '自定义 API 需手动输入模型' : '输入密钥后自动获取模型列表';
            }
        }

        // 手动刷新模型列表
        async function refreshModelList() {
            const btn = document.querySelector('.refresh-models-btn');
            if (btn) {
                btn.classList.add('spinning');
            }
            
            // 清除缓存
            const cacheKey = `ggb_models_${currentProvider}`;
            localStorage.removeItem(cacheKey);
            localStorage.removeItem(`${cacheKey}_time`);
            
            showToast('正在刷新模型列表...', 'info');
            await loadModelList(currentProvider);
            
            if (btn) {
                btn.classList.remove('spinning');
            }
        }

        // 从 API 获取模型列表
        async function fetchModelsFromAPI(provider, apiKey) {
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 12000);
            let response;

            try {
                response = await fetch(`${provider.baseUrl}${provider.modelsEndpoint}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    signal: controller.signal
                });
            } finally {
                clearTimeout(timeout);
            }
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            
            // 解析模型列表（处理不同服务商的格式）
            let models = [];
            if (data.data && Array.isArray(data.data)) {
                // OpenAI 格式: { data: [{ id: 'gpt-4', ... }] }
                models = data.data
                    .filter(m => m.id && !m.id.includes('embedding') && !m.id.includes('dall-e'))
                    .map(m => ({
                        id: m.id,
                        name: m.id
                    }))
                    .sort((a, b) => a.id.localeCompare(b.id));
            } else if (Array.isArray(data)) {
                // 某些服务商可能直接返回数组
                models = data
                    .filter(m => m.id || m.name)
                    .map(m => ({
                        id: m.id || m.name,
                        name: m.name || m.id
                    }));
            }
            
            return models;
        }

        // 切换密钥可见性（左侧已删除，调用右侧版本）
        function toggleApiKeyVisibility() {
            toggleRightApiKeyVisibility();
        }

        // 检测 API 密钥（左侧已删除，调用右侧版本）
        function checkApiKey() {
            checkRightApiKey();
        }

        // 保存 API 设置
        function saveApiSettings() {
            const provider = currentProvider;
            const rightApiKey = document.getElementById('right-api-key');
            const rightApiModel = document.getElementById('right-api-model');
            const key = rightApiKey ? rightApiKey.value.trim() : '';
            const model = rightApiModel ? rightApiModel.value : '';
            
            localStorage.setItem('ggb_api_provider', provider);
            if (model) localStorage.setItem('ggb_api_model', model);
            
            // 所有服务商（内置+自定义）都使用独立的密钥存储
            if (key) {
                const savedKeys = JSON.parse(localStorage.getItem('ggb_provider_keys') || '{}');
                savedKeys[provider] = key;
                localStorage.setItem('ggb_provider_keys', JSON.stringify(savedKeys));
            }
        }
        

        // ========== 提示词管理（简化版） ==========
        
        // 加载自定义提示词列表
        function loadCustomPrompts() {
            const saved = localStorage.getItem('ggb_custom_prompts');
            if (saved) {
                try {
                    customPrompts = JSON.parse(saved);
                } catch (e) {
                    customPrompts = [];
                }
            }
            renderPromptList();
        }

        // 渲染提示词列表
        function renderPromptList() {
            const currentId = localStorage.getItem('ggb_current_prompt_id') || 'default';
            
            let html = `
                <div class="prompt-list-item ${currentId === 'default' ? 'active' : ''}" onclick="selectPrompt('default')">
                    <div class="prompt-list-info">
                        <div class="prompt-list-name">🎯 默认提示词</div>
                        <div class="prompt-list-desc">平衡的通用提示词</div>
                    </div>
                    ${currentId === 'default' ? '<span class="prompt-list-check">✓</span>' : ''}
                </div>
            `;
            
            customPrompts.forEach((prompt, index) => {
                html += `
                    <div class="prompt-list-item ${currentId === prompt.id ? 'active' : ''}" onclick="selectPrompt('${prompt.id}')">
                        <div class="prompt-list-info">
                            <div class="prompt-list-name">${escapeHtml(prompt.name)}</div>
                            <div class="prompt-list-desc">自定义提示词</div>
                        </div>
                        <div class="prompt-list-actions" onclick="event.stopPropagation()">
                            <button class="btn-icon-small" onclick="editPrompt('${prompt.id}')" title="编辑">✏️</button>
                            <button class="btn-icon-small" onclick="deletePrompt('${prompt.id}')" title="删除">🗑️</button>
                            ${currentId === prompt.id ? '<span class="prompt-list-check">✓</span>' : ''}
                        </div>
                    </div>
                `;
            });
            
            // 渲染到右侧面板
            const rightContainer = document.getElementById('right-prompt-list');
            if (rightContainer) {
                rightContainer.innerHTML = html;
            }
        }

        // 选择提示词
        function selectPrompt(id) {
            localStorage.setItem('ggb_current_prompt_id', id);
            renderPromptList();
            
            if (id === 'default') {
                showToast('已切换到默认提示词', 'success');
            } else {
                const prompt = customPrompts.find(p => p.id === id);
                if (prompt) {
                    showToast(`已切换到「${prompt.name}」`, 'success');
                }
            }
        }

        // 当前编辑的提示词ID
        let editingPromptId = null;

        // 打开提示词编辑器
        function openPromptEditor(promptId = null) {
            const modal = document.getElementById('prompt-modal');
            const nameInput = document.getElementById('prompt-name-input');
            const editor = document.getElementById('prompt-editor');
            const title = document.getElementById('prompt-editor-title');
            
            editingPromptId = promptId;
            
            if (promptId) {
                // 编辑模式
                const prompt = customPrompts.find(p => p.id === promptId);
                if (prompt) {
                    title.textContent = '📝 编辑提示词';
                    nameInput.value = prompt.name;
                    editor.value = prompt.template;
                }
            } else {
                // 添加模式
                title.textContent = '📝 添加提示词';
                nameInput.value = '';
                editor.value = '';
            }
            
            modal.classList.add('show');
            nameInput.focus();
        }

        // 关闭提示词编辑器
        function closePromptEditor() {
            const modal = document.getElementById('prompt-modal');
            modal.classList.remove('show');
            editingPromptId = null;
        }

        // 点击遮罩关闭
        function closePromptEditorOnOverlay(event) {
            if (event.target === event.currentTarget) {
                closePromptEditor();
            }
        }

        // 插入变量
        function insertVariable(variable) {
            const editor = document.getElementById('prompt-editor');
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const text = editor.value;
            
            editor.value = text.substring(0, start) + variable + text.substring(end);
            editor.focus();
            editor.selectionStart = editor.selectionEnd = start + variable.length;
        }

        // 载入默认模板
        function loadDefaultPromptTemplate() {
            if (confirm('确定要载入默认模板吗？这将覆盖当前编辑内容。')) {
                setInputValue('prompt-editor', DEFAULT_PROMPT);
            }
        }

        // 保存提示词
        function savePrompt() {
            const nameInput = document.getElementById('prompt-name-input');
            const editor = document.getElementById('prompt-editor');
            const name = nameInput.value.trim();
            const template = editor.value.trim();
            
            if (!name) {
                showToast('请输入提示词名称', 'warning');
                nameInput.focus();
                return;
            }
            
            if (!template) {
                showToast('提示词内容不能为空', 'warning');
                editor.focus();
                return;
            }
            
            if (editingPromptId) {
                // 更新现有提示词
                const index = customPrompts.findIndex(p => p.id === editingPromptId);
                if (index !== -1) {
                    customPrompts[index].name = name;
                    customPrompts[index].template = template;
                }
            } else {
                // 添加新提示词
                const newPrompt = {
                    id: 'custom_' + Date.now(),
                    name: name,
                    template: template
                };
                customPrompts.push(newPrompt);
                
                // 自动切换到新提示词
                localStorage.setItem('ggb_current_prompt_id', newPrompt.id);
            }
            
            // 保存到 localStorage
            localStorage.setItem('ggb_custom_prompts', JSON.stringify(customPrompts));
            
            // 刷新列表并关闭
            renderPromptList();
            closePromptEditor();
            
            showToast(editingPromptId ? '提示词已更新' : '提示词已添加', 'success');
        }

        // 编辑提示词
        function editPrompt(id) {
            openPromptEditor(id);
        }

        // 删除提示词
        function deletePrompt(id) {
            const prompt = customPrompts.find(p => p.id === id);
            if (!prompt) return;
            
            if (!confirm(`确定要删除提示词「${prompt.name}」吗？`)) return;
            
            customPrompts = customPrompts.filter(p => p.id !== id);
            localStorage.setItem('ggb_custom_prompts', JSON.stringify(customPrompts));
            
            // 如果删除的是当前使用的，切换回默认
            const currentId = localStorage.getItem('ggb_current_prompt_id');
            if (currentId === id) {
                localStorage.setItem('ggb_current_prompt_id', 'default');
            }
            
            renderPromptList();
            showToast('提示词已删除', 'success');
        }

        // 构建系统提示词
        function buildSystemPrompt() {
            const currentId = localStorage.getItem('ggb_current_prompt_id') || 'default';
            let template = DEFAULT_PROMPT;
            
            if (currentId !== 'default') {
                const prompt = customPrompts.find(p => p.id === currentId);
                if (prompt) {
                    template = prompt.template;
                }
            }
            
            // 准备变量值
            const currentObjects = commandHistory.length > 0 
                ? commandHistory.slice(-20).join('\n')
                : '（画布为空）';
            
            // 替换变量
            return template
                .replace(/\{\{CURRENT_OBJECTS\}\}/g, currentObjects)
                .replace(/\{\{COMMAND_HISTORY\}\}/g, currentObjects)
                .replace(/\{\{USER_INPUT\}\}/g, '');
        }

        // ========== 初始化 ==========
        loadTheme();
        loadSettings();
        loadCustomProviders();  // 加载自定义服务商
        renderProviderList();
        loadDefaultPromptFromFile();
        loadCustomPrompts();
        initCommandEditorGuard();
        updateExportButtonText();
        initResizer();
        initCenterResizer();
        loadPanelWidth();
        initChatImagePasteSupport();
        renderPendingImagePreview();
        
        // 监听 API 设置变化（右侧面板）
        document.getElementById('right-api-model')?.addEventListener('change', handleModelSelectChange);
        
        // API Key 输入防抖处理
        let apiKeyDebounceTimer;
        document.getElementById('right-api-key')?.addEventListener('input', (e) => {
            clearTimeout(apiKeyDebounceTimer);
            apiKeyDebounceTimer = setTimeout(() => {
                saveApiSettings();
                // 如果输入了完整的 Key，自动刷新模型列表
                if (e.target.value.length > 20) {
                    if (currentProvider.startsWith('custom_')) {
                        const index = parseInt(currentProvider.replace('custom_', ''));
                        loadModelListForCustomProvider(index, e.target.value);
                    } else {
                        loadModelList(currentProvider);
                    }
                }
            }, 1000); // 1秒后自动刷新
        });
    </script>
</body>
</html>
